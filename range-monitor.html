<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Range Monitor ‚Äî efixDI/USDC | EFIX Protocol</title>
    <meta name="description" content="Live Uniswap V3 liquidity range monitor for efixDI/USDC on Polygon.">
    <meta property="og:title" content="efixDI Range Monitor ‚Äî EFIX Protocol">
    <meta property="og:description" content="Live Uniswap V3 position monitoring with GBM range optimization.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚óà</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --bg2: #111118;
            --bg3: #16161f;
            --surface: #1a1a24;
            --surface2: #22222e;
            --border: rgba(255,255,255,0.06);
            --border2: rgba(255,255,255,0.12);
            --text: #a1a1aa;
            --text2: #71717a;
            --text3: #52525b;
            --white: #fafafa;
            --green: #22c55e;
            --green-light: #4ade80;
            --cyan: #06b6d4;
            --blue: #3b82f6;
            --yellow: #eab308;
            --orange: #f97316;
            --red: #ef4444;
            --purple: #8b5cf6;
            --gradient: linear-gradient(135deg, #22c55e, #06b6d4);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* ‚îÄ‚îÄ NAVBAR (matches efix.finance) ‚îÄ‚îÄ */
        .navbar {
            position: sticky; top: 0; z-index: 100;
            background: rgba(10,10,15,0.8); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0 40px; height: 64px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-brand { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .nav-logo { width: 36px; height: 36px; border-radius: 10px; }
        .nav-links { display: flex; align-items: center; gap: 32px; }
        .nav-links a {
            color: var(--text2); text-decoration: none; font-size: 14px; font-weight: 500;
            transition: color 0.2s;
        }
        .nav-links a:hover { color: var(--white); }
        .nav-links a.active { color: var(--green-light); }
        .nav-cta {
            background: var(--gradient); color: #000; padding: 8px 20px;
            border-radius: 8px; font-weight: 600; font-size: 14px; text-decoration: none;
            transition: opacity 0.2s;
        }
        .nav-cta:hover { opacity: 0.9; }

        /* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
        .main { max-width: 1100px; margin: 0 auto; padding: 48px 24px 60px; }

        /* Hero */
        .hero { text-align: center; margin-bottom: 48px; }
        .hero-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);
            border-radius: 100px; padding: 6px 16px; margin-bottom: 20px;
            font-size: 13px; color: var(--green-light); font-weight: 500;
        }
        .hero-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
        @keyframes pulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
            50% { box-shadow: 0 0 0 6px rgba(34,197,94,0); }
        }
        .hero h1 {
            font-size: 42px; font-weight: 800; letter-spacing: -1.5px;
            background: var(--gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 12px;
        }
        .hero p { color: var(--text2); font-size: 16px; max-width: 560px; margin: 0 auto; }

        /* Alert */
        .alert {
            border-radius: 12px; padding: 16px 20px; margin-bottom: 32px;
            display: flex; align-items: center; gap: 12px;
            font-size: 14px; font-weight: 500;
        }
        .alert-ok { background: rgba(34,197,94,0.06); border: 1px solid rgba(34,197,94,0.15); color: var(--green-light); }
        .alert-warn { background: rgba(234,179,8,0.06); border: 1px solid rgba(234,179,8,0.15); color: var(--yellow); }
        .alert-crit { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.15); color: var(--red); }
        .alert-icon { font-size: 18px; }

        /* Section */
        .section { margin-bottom: 40px; }
        .section-header {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--text3); font-weight: 600; margin-bottom: 16px;
        }

        /* Metric cards */
        .metrics-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 32px; }
        .metric {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
            transition: border-color 0.2s;
        }
        .metric:hover { border-color: var(--border2); }
        .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text3); margin-bottom: 8px; font-weight: 600; }
        .metric-value { font-size: 28px; font-weight: 700; color: var(--white); font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
        .metric-value.green { color: var(--green-light); }
        .metric-value.yellow { color: var(--yellow); }
        .metric-value.red { color: var(--red); }
        .metric-value.cyan { color: var(--cyan); }
        .metric-sub { font-size: 12px; color: var(--text3); margin-top: 4px; font-family: 'JetBrains Mono', monospace; }

        /* Range card */
        .range-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px; margin-bottom: 32px;
        }
        .range-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .range-title { font-size: 15px; font-weight: 600; color: var(--white); }
        .range-tag {
            font-size: 11px; font-family: 'JetBrains Mono', monospace; font-weight: 500;
            background: rgba(34,197,94,0.08); color: var(--green); padding: 4px 10px;
            border-radius: 6px; border: 1px solid rgba(34,197,94,0.15);
        }
        .range-bar-wrap { position: relative; margin: 0 0 28px; padding: 20px 0; }
        .range-bar {
            height: 10px; background: var(--bg3); border-radius: 5px; position: relative; overflow: visible;
        }
        .range-zone { position: absolute; height: 100%; }
        .rz-left { left:0; width:12.5%; background: rgba(234,179,8,0.12); border-radius: 5px 0 0 5px; }
        .rz-mid { left:12.5%; width:75%; background: rgba(34,197,94,0.10); }
        .rz-right { right:0; width:12.5%; background: rgba(234,179,8,0.12); border-radius: 0 5px 5px 0; }
        .range-cursor {
            position: absolute; top: -7px; width: 4px; height: 24px;
            background: var(--white); border-radius: 2px;
            transition: left 1s cubic-bezier(0.16,1,0.3,1);
            box-shadow: 0 0 12px rgba(255,255,255,0.25);
        }
        .range-cursor-tag {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            margin-bottom: 8px; font-size: 11px; font-family: 'JetBrains Mono', monospace;
            color: var(--white); white-space: nowrap; font-weight: 600;
            background: var(--surface2); padding: 3px 8px; border-radius: 4px;
        }
        .range-ends { display: flex; justify-content: space-between; font-size: 12px; font-family: 'JetBrains Mono', monospace; color: var(--text2); }
        .range-ends small { display: block; color: var(--text3); font-size: 11px; margin-top: 2px; }

        /* Contract info strip */
        .info-strip {
            display: flex; gap: 24px; flex-wrap: wrap;
            padding: 14px 20px; background: var(--bg2); border-radius: 10px;
            font-size: 12px; font-family: 'JetBrains Mono', monospace; color: var(--text2);
        }
        .info-strip span { color: var(--green); }

        /* Two-column panels */
        .panels { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }
        .panel {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 24px;
        }
        .panel-title { font-size: 14px; font-weight: 600; color: var(--white); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .panel-row { display: flex; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .panel-row:last-child { border-bottom: none; }
        .panel-row .k { color: var(--text2); }
        .panel-row .v { color: var(--white); font-weight: 600; font-family: 'JetBrains Mono', monospace; font-size: 12px; }

        /* Formula */
        .formula-box {
            background: var(--bg2); border-left: 3px solid var(--green);
            border-radius: 0 10px 10px 0; padding: 20px 24px; margin: 20px 0;
            font-family: 'JetBrains Mono', monospace; font-size: 13px;
            line-height: 2; color: var(--text);
        }
        .formula-box strong { color: var(--green-light); }
        .formula-box .dim { color: var(--text3); }

        /* Timeline */
        .timeline-grid {
            display: grid; grid-template-columns: repeat(4,1fr); gap: 12px;
            margin-bottom: 28px;
        }
        .tl-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
        }
        .tl-card .metric-value { font-size: 24px; }

        .timeline { position: relative; padding-left: 32px; margin: 28px 0; }
        .timeline::before {
            content:''; position: absolute; left: 11px; top:0; height:100%; width:2px;
            background: linear-gradient(180deg, var(--green) 0%, var(--yellow) 40%, var(--red) 70%, var(--green) 100%);
        }
        .tl-item { position: relative; margin-bottom: 24px; }
        .tl-item::before {
            content:''; position: absolute; left: -26px; top:4px;
            width:10px; height:10px; border-radius:50%;
        }
        .tl-item.g::before { background: var(--green); box-shadow: 0 0 12px rgba(34,197,94,0.4); }
        .tl-item.y::before { background: var(--yellow); box-shadow: 0 0 12px rgba(234,179,8,0.4); }
        .tl-item.o::before { background: var(--orange); box-shadow: 0 0 12px rgba(249,115,22,0.4); }
        .tl-item.r::before { background: var(--red); box-shadow: 0 0 12px rgba(239,68,68,0.4); }
        .tl-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .tl-desc { font-size: 13px; color: var(--text2); }
        .tl-tag {
            display: inline-block; font-size: 11px; font-family: 'JetBrains Mono', monospace;
            background: var(--bg3); color: var(--text3); padding: 2px 8px;
            border-radius: 4px; margin-left: 6px;
        }

        /* Methodology text */
        .method-text { font-size: 14px; line-height: 1.85; color: var(--text2); max-width: 800px; }
        .method-text code {
            background: rgba(34,197,94,0.08); color: var(--green-light);
            padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px;
        }

        /* ‚îÄ‚îÄ FOOTER (matches efix.finance) ‚îÄ‚îÄ */
        .footer {
            border-top: 1px solid var(--border); margin-top: 60px; padding: 40px 24px 32px;
            max-width: 1100px; margin-left: auto; margin-right: auto;
        }
        .footer-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 40px; margin-bottom: 32px; }
        .footer-brand { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .footer-brand img { width: 32px; height: 32px; border-radius: 8px; }
        .footer-desc { font-size: 13px; color: var(--text2); line-height: 1.6; }
        .footer-col h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-bottom: 12px; font-weight: 600; }
        .footer-col a { display: block; font-size: 13px; color: var(--text2); text-decoration: none; margin-bottom: 8px; transition: color 0.2s; }
        .footer-col a:hover { color: var(--white); }
        .footer-bottom { font-size: 11px; color: var(--text3); text-align: center; padding-top: 20px; border-top: 1px solid var(--border); }

        /* Responsive */
        @media(max-width:768px) {
            .hero h1 { font-size: 28px; }
            .metrics-grid, .timeline-grid { grid-template-columns: repeat(2,1fr); }
            .panels { grid-template-columns: 1fr; }
            .footer-grid { grid-template-columns: 1fr 1fr; }
            .nav-links { display: none; }
            .navbar { padding: 0 20px; }
        }
        @media(max-width:480px) {
            .metrics-grid, .timeline-grid { grid-template-columns: 1fr; }
            .footer-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
    <a href="/" class="nav-brand">
        <img src="./logo_efix_400x400.jpg" alt="EFIX" class="nav-logo">
    </a>
    <div class="nav-links">
        <a href="/#how">How It Works</a>
        <a href="/#yield">Yield</a>
        <a href="/#contracts">Contracts</a>
        <a href="/range-monitor" class="active">Range Monitor</a>
        <a href="/#whitepaper">Whitepaper</a>
        <a href="/app" class="nav-cta">Launch App ‚Üí</a>
    </div>
</nav>

<div class="main">

    <!-- HERO -->
    <div class="hero">
        <div class="hero-badge">
            <span class="hero-dot"></span>
            <span id="liveStatus">Connecting to Polygon RPC...</span>
        </div>
        <h1>Range Monitor</h1>
        <p>Live Uniswap V3 position tracking for efixDI/USDC on Polygon with GBM-optimized range strategy.</p>
    </div>

    <!-- ALERT -->
    <div class="alert alert-ok" id="alertBar">
        <span class="alert-icon">‚è≥</span>
        <span id="alertText">Loading on-chain data...</span>
    </div>

    <!-- POSITION METRICS -->
    <div class="section">
        <div class="section-header">Current Position</div>
        <div class="metrics-grid">
            <div class="metric">
                <div class="metric-label">efixDI Price</div>
                <div class="metric-value" id="currentPrice">‚Äî</div>
                <div class="metric-sub" id="impliedFx">‚Äî</div>
            </div>
            <div class="metric">
                <div class="metric-label">Range Utilization</div>
                <div class="metric-value green" id="utilization">‚Äî</div>
                <div class="metric-sub" id="direction">‚Äî</div>
            </div>
            <div class="metric">
                <div class="metric-label">Est. Days to Exit</div>
                <div class="metric-value cyan" id="estDays">‚Äî</div>
                <div class="metric-sub">First Passage Time</div>
            </div>
            <div class="metric">
                <div class="metric-label">Capital Efficiency</div>
                <div class="metric-value" id="efficiency">‚Äî</div>
                <div class="metric-sub">vs full-range LP</div>
            </div>
        </div>
    </div>

    <!-- RANGE VISUALIZER -->
    <div class="range-card">
        <div class="range-header">
            <div class="range-title">Position in Range</div>
            <div class="range-tag">NFT #2847265</div>
        </div>
        <div class="range-bar-wrap">
            <div class="range-bar">
                <div class="range-zone rz-left"></div>
                <div class="range-zone rz-mid"></div>
                <div class="range-zone rz-right"></div>
                <div class="range-cursor" id="rangeCursor" style="left:50%">
                    <span class="range-cursor-tag" id="cursorLabel">$0.1953</span>
                </div>
            </div>
        </div>
        <div class="range-ends">
            <div><span id="lowerPrice">$0.0000</span><small id="lowerFx">‚Äî</small></div>
            <div style="text-align:center; color:var(--text3)">‚óÑ BRL weakens ¬∑ Safe Zone ¬∑ BRL strengthens ‚ñ∫</div>
            <div style="text-align:right;"><span id="upperPrice">$0.0000</span><small id="upperFx">‚Äî</small></div>
        </div>
        <div class="info-strip" style="margin-top:20px;">
            <div>Pool: <span>efixDI/USDC</span></div>
            <div>Fee: <span>0.05%</span></div>
            <div>Network: <span>Polygon</span></div>
            <div>Block: <span id="blockNumber">#‚Äî</span></div>
            <div>Updated: <span id="lastUpdate">‚Äî</span></div>
        </div>
    </div>

    <!-- STRATEGY PANELS -->
    <div class="section">
        <div class="section-header">Liquidity Strategy</div>
        <div class="panels">
            <div class="panel">
                <div class="panel-title">‚óà Active Strategy</div>
                <div class="panel-row"><span class="k">Model</span><span class="v">GBM + First Passage</span></div>
                <div class="panel-row"><span class="k">Confidence</span><span class="v">95%</span></div>
                <div class="panel-row"><span class="k">Horizon</span><span class="v">30 days</span></div>
                <div class="panel-row"><span class="k">Annualized Vol</span><span class="v">10.5%</span></div>
                <div class="panel-row"><span class="k">Period Vol</span><span class="v" id="volPeriod">3.01%</span></div>
                <div class="panel-row"><span class="k">Z-Score</span><span class="v">1.96</span></div>
            </div>
            <div class="panel">
                <div class="panel-title">üîÑ Updated Optimal Range</div>
                <div class="panel-row"><span class="k">Suggested Lower</span><span class="v" id="optLower">‚Äî</span></div>
                <div class="panel-row"><span class="k">Suggested Upper</span><span class="v" id="optUpper">‚Äî</span></div>
                <div class="panel-row"><span class="k">FX Range</span><span class="v" id="optFx">‚Äî</span></div>
                <div class="panel-row"><span class="k">Width</span><span class="v" id="optWidth">‚Äî</span></div>
                <div class="panel-row"><span class="k">Efficiency (new)</span><span class="v" id="optEff">‚Äî</span></div>
                <div class="panel-row"><span class="k">Est. next rebal</span><span class="v" id="optRebal">‚Äî</span></div>
            </div>
        </div>
        <div class="formula-box">
            <strong>Range Formula:</strong><br>
            P_lower = P_spot √ó exp(-z √ó œÉ √ó ‚àö(T/365))<br>
            P_upper = P_spot √ó exp(+z √ó œÉ √ó ‚àö(T/365))<br><br>
            <strong>First Passage Time:</strong><br>
            E[œÑ] ‚âà (barrier / œÉ_daily)¬≤<br><br>
            <span class="dim">z = 1.96 (95%), œÉ = 10.5% ann., T = 30 days, Efficiency = ‚àöP / (‚àöP_upper - ‚àöP_lower)</span>
        </div>
    </div>

    <!-- REBALANCING TIMELINE -->
    <div class="section">
        <div class="section-header">Rebalancing Timeline</div>
        <div class="timeline-grid">
            <div class="tl-card">
                <div class="metric-label">Rebal / Month</div>
                <div class="metric-value cyan" id="rebalMonth">‚Äî</div>
            </div>
            <div class="tl-card">
                <div class="metric-label">Rebal / Year</div>
                <div class="metric-value cyan" id="rebalYear">‚Äî</div>
            </div>
            <div class="tl-card">
                <div class="metric-label">Time per Rebal</div>
                <div class="metric-value">~5min</div>
            </div>
            <div class="tl-card">
                <div class="metric-label">Cost (Polygon gas)</div>
                <div class="metric-value">~$0.02</div>
            </div>
        </div>
        <div class="timeline">
            <div class="tl-item g">
                <div class="tl-title" style="color:var(--green-light)">Position opened <span class="tl-tag">Day 0</span></div>
                <div class="tl-desc">Range set, monitor active. No action needed.</div>
            </div>
            <div class="tl-item y">
                <div class="tl-title" style="color:var(--yellow)">‚ö†Ô∏è Warning (75%) <span class="tl-tag" id="tagWarning">~Day ?</span></div>
                <div class="tl-desc">Price consumed 75% of range. Monitor closely.</div>
            </div>
            <div class="tl-item o">
                <div class="tl-title" style="color:var(--orange)">üî∂ Critical (90%) <span class="tl-tag" id="tagCritical">~Day ?</span></div>
                <div class="tl-desc">Prepare new position. Have the transaction ready.</div>
            </div>
            <div class="tl-item r">
                <div class="tl-title" style="color:var(--red)">üö® Out of Range (100%) <span class="tl-tag" id="tagExit">~Day ?</span></div>
                <div class="tl-desc">Rebalance NOW: Remove liquidity ‚Üí New position with updated range.</div>
            </div>
            <div class="tl-item g">
                <div class="tl-title" style="color:var(--green-light)">‚úÖ New position <span class="tl-tag">Reset</span></div>
                <div class="tl-desc">Cycle restarts with GBM-recalculated range at current price.</div>
            </div>
        </div>
    </div>

    <!-- METHODOLOGY -->
    <div class="section">
        <div class="section-header">Methodology</div>
        <div class="method-text">
            <p>The range is calculated using <code>Geometric Brownian Motion</code> ‚Äî the same stochastic model 
            behind Black-Scholes option pricing. It models efixDI/USDC price as a function of BRL/USD exchange rate,
            using implied volatility extracted from the 6-month historical range (R$5.18‚Äì5.59, vol ‚âà 10.5% ann.).
            The formula projects price bounds at 95% confidence over 30 days.</p>
            <p style="margin-top:14px;">Rebalancing frequency is estimated via <code>First Passage Time</code> theory,
            calculating the expected time for a Brownian process to hit a barrier. All data is read directly from
            Polygon blockchain via <code>NonfungiblePositionManager</code> and <code>UniswapV3Pool.slot0()</code>
            ‚Äî no backend, no API keys. Auto-refresh every 30 seconds.</p>
        </div>
    </div>

</div>

<!-- FOOTER -->
<footer class="footer">
    <div class="footer-grid">
        <div>
            <div class="footer-brand">
                <img src="./logo_efix_400x400.jpg" alt="EFIX">
                <span style="color:var(--white); font-weight:600;">EFIX Protocol</span>
            </div>
            <div class="footer-desc">Bridging Brazilian fixed-income assets into decentralized finance. CVM-regulated. Built for composability.</div>
        </div>
        <div class="footer-col">
            <h4>Protocol</h4>
            <a href="https://app.morpho.org/base/vault/0xf4A3FaDcEf350B2F168F97Cdbaa2221FF29ACBd5" target="_blank">Morpho Vault</a>
            <a href="https://polygonscan.com/address/0x04082b283818D9d0dd9Ee8742892eEe5CC396441" target="_blank">Token (Polygon)</a>
            <a href="https://basescan.org/address/0xF5cA55f3ea5Bcd180aEa6dF9E05a0E63A66f5608" target="_blank">Token (Base)</a>
            <a href="https://app.uniswap.org/positions/v3/polygon/2847265" target="_blank">Uniswap V3 Position</a>
        </div>
        <div class="footer-col">
            <h4>Resources</h4>
            <a href="./efixDI_Whitepaper_v1.pdf">Whitepaper</a>
            <a href="https://github.com/Ernesto711/efix-pr-repo" target="_blank">GitHub</a>
            <a href="/#how">Documentation</a>
        </div>
        <div class="footer-col">
            <h4>Contact</h4>
            <a href="mailto:contato@efix.com.br">contato@efix.com.br</a>
            <a>Rio de Janeiro, Brazil</a>
        </div>
    </div>
    <div class="footer-bottom">
        ¬© 2026 Efix Securitizadora S.A. ¬∑ CNPJ 60.756.859/0001-57 ¬∑ CVM Act 23.635/2025 ¬∑ Polygon ¬∑ Base ¬∑ Morpho Blue ¬∑ LayerZero
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
<script>
(function(){
    const C = {
        pid: 2847265,
        nft: '0xC36442b4a4522E871399CD717aBDD847Ab11FE88',
        fac: '0x1F98431c8aD98523631AE4a59f267346ea31F984',
        rpcs: [
            'https://polygon-bor-rpc.publicnode.com',
            'https://polygon.drpc.org',
            'https://1rpc.io/matic',
            'https://polygon.meowrpc.com'
        ],
        ms: 30000, z: 1.96, vol: 0.105, days: 30,
    };

    // CORRECT ABI: slot0 returns (uint160 sqrtPriceX96, int24 tick, ...)
    const NABI = ['function positions(uint256) view returns (uint96,address,address,address,uint24,int24,int24,uint128,uint256,uint256,uint128,uint128)'];
    const FABI = ['function getPool(address,address,uint24) view returns (address)'];
    const PABI = [
        'function slot0() view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)',
        'function liquidity() view returns (uint128)'
    ];

    const t2p = (t, d0=18, d1=6) => Math.pow(1.0001, t) * Math.pow(10, d0 - d1);
    const s2p = (s, d0=18, d1=6) => { const x = Number(s) / (2**96); return x * x * Math.pow(10, d0 - d1); };
    const gbm = (p,v,d,z) => { const pv=v*Math.sqrt(d/365), l=p*Math.exp(-z*pv), u=p*Math.exp(z*pv); return {lower:l, upper:u, pVol:pv, eff:Math.sqrt(p)/(Math.sqrt(u)-Math.sqrt(l))}; };
    const fpt = (v,b) => { const dv=v/Math.sqrt(365); return Math.pow(b/dv, 2); };

    async function gp() {
        for (const u of C.rpcs) {
            try { const p = new ethers.JsonRpcProvider(u); await p.getBlockNumber(); return p; }
            catch { continue; }
        }
        throw new Error('All RPCs failed');
    }

    const $ = id => document.getElementById(id);

    async function fetchData() {
        const pv = await gp(), bn = await pv.getBlockNumber();
        const nft = new ethers.Contract(C.nft, NABI, pv);
        const pos = await nft.positions(C.pid);
        const token0=pos[2], token1=pos[3], fee=Number(pos[4]);
        const tickLower=Number(pos[5]), tickUpper=Number(pos[6]);

        const fac = new ethers.Contract(C.fac, FABI, pv);
        const poolAddr = await fac.getPool(token0, token1, fee);
        const pool = new ethers.Contract(poolAddr, PABI, pv);
        const [slot0, poolLiq] = await Promise.all([pool.slot0(), pool.liquidity()]);

        // FIXED: slot0[0] = sqrtPriceX96 (uint160), slot0[1] = tick (int24)
        const sqrtPriceX96 = slot0[0];
        const currentTick = Number(slot0[1]);

        const currentPrice = s2p(sqrtPriceX96);
        const priceLower = t2p(tickLower);
        const priceUpper = t2p(tickUpper);
        const mid = (priceUpper + priceLower) / 2;
        const halfW = (priceUpper - priceLower) / 2;

        return {
            cp: currentPrice, pL: priceLower, pU: priceUpper,
            ct: currentTick, tL: tickLower, tU: tickUpper,
            ut: (currentPrice - mid) / halfW,
            ir: currentTick >= tickLower && currentTick <= tickUpper,
            bn
        };
    }

    function ui(d) {
        const au = Math.abs(d.ut), dir = d.ut > 0 ? '‚Üí Upper (BRL‚Üë)' : '‚Üê Lower (BRL‚Üì)', rw = d.pU - d.pL;

        $('currentPrice').textContent = '$' + d.cp.toFixed(5);
        $('impliedFx').textContent = '‚âà R$' + (1/d.cp).toFixed(2) + '/USD';

        const ue = $('utilization');
        ue.textContent = (au * 100).toFixed(1) + '%';
        ue.className = 'metric-value ' + (au > 0.9 ? 'red' : au > 0.75 ? 'yellow' : 'green');
        $('direction').textContent = dir;

        const dp = (1 - au) * (rw / d.cp) / 2;
        const dte = fpt(C.vol, Math.max(dp, 0.001));
        const eff = Math.sqrt(d.cp) / (Math.sqrt(d.pU) - Math.sqrt(d.pL));
        const ry = 365 / dte, rm = 30 / dte;

        const de = $('estDays');
        de.textContent = '~' + Math.round(dte) + 'd';
        de.className = 'metric-value ' + (dte < 7 ? 'red' : dte < 21 ? 'yellow' : 'cyan');
        $('efficiency').textContent = eff.toFixed(1) + 'x';
        $('rebalMonth').textContent = rm < 1 ? '<1' : '~' + rm.toFixed(1);
        $('rebalYear').textContent = '~' + Math.round(ry);

        // Range bar
        const cp = Math.max(0, Math.min(100, ((d.cp - d.pL) / rw) * 100));
        $('rangeCursor').style.left = cp + '%';
        $('cursorLabel').textContent = '$' + d.cp.toFixed(5);
        $('lowerPrice').textContent = '$' + d.pL.toFixed(5);
        $('lowerFx').textContent = '‚âà R$' + (1/d.pL).toFixed(2) + '/USD';
        $('upperPrice').textContent = '$' + d.pU.toFixed(5);
        $('upperFx').textContent = '‚âà R$' + (1/d.pU).toFixed(2) + '/USD';
        $('blockNumber').textContent = '#' + d.bn.toLocaleString();
        $('lastUpdate').textContent = new Date().toLocaleTimeString('pt-BR');
        $('liveStatus').textContent = d.ir ? 'In Range ¬∑ Live on Polygon' : '‚ö† Out of Range';

        // Alert
        const ab = $('alertBar'), at = $('alertText'), ai = ab.querySelector('.alert-icon');
        if (!d.ir) { ab.className='alert alert-crit'; ai.textContent='üö®'; at.innerHTML='<strong>OUT OF RANGE</strong> ‚Äî Rebalancing needed. Remove liquidity and create new position.'; }
        else if (au >= 0.90) { ab.className='alert alert-crit'; ai.textContent='üî∂'; at.innerHTML='<strong>CRITICAL ZONE</strong> ‚Äî '+(au*100).toFixed(0)+'% of range used. Prepare rebalancing.'; }
        else if (au >= 0.75) { ab.className='alert alert-warn'; ai.textContent='‚ö†Ô∏è'; at.innerHTML='<strong>WARNING</strong> ‚Äî '+(au*100).toFixed(0)+'% of range consumed.'; }
        else { ab.className='alert alert-ok'; ai.textContent='‚úÖ'; at.innerHTML='Position healthy ‚Äî '+(au*100).toFixed(0)+'% of range used. No action needed.'; }

        // Optimal range
        const o = gbm(d.cp, C.vol, C.days, C.z);
        $('optLower').textContent = '$' + o.lower.toFixed(5);
        $('optUpper').textContent = '$' + o.upper.toFixed(5);
        $('optFx').textContent = 'R$' + (1/o.upper).toFixed(2) + '‚Äì' + (1/o.lower).toFixed(2);
        $('optWidth').textContent = '¬±' + ((o.upper/d.cp - 1)*100).toFixed(1) + '%';
        $('optEff').textContent = o.eff.toFixed(1) + 'x';
        $('volPeriod').textContent = (o.pVol * 100).toFixed(2) + '%';
        const oh = o.upper / d.cp - 1, of_ = fpt(C.vol, oh);
        $('optRebal').textContent = '~' + Math.round(of_) + 'd';
        $('tagWarning').textContent = '~Day ' + Math.round(fpt(C.vol, oh*0.75));
        $('tagCritical').textContent = '~Day ' + Math.round(fpt(C.vol, oh*0.90));
        $('tagExit').textContent = '~Day ' + Math.round(of_);
    }

    async function go() {
        try { ui(await fetchData()); }
        catch(e) { console.error('Fetch error:', e); $('liveStatus').textContent = 'RPC Error ‚Äî retrying...'; }
    }
    go();
    setInterval(go, C.ms);
})();
</script>
</body>
</html>
