<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Range Monitor ‚Äî efixDI/USDC | EFIX Protocol</title>
    <meta name="description" content="Live Uniswap V3 liquidity range monitor for efixDI/USDC on Polygon.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚óà</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --surface: #ffffff;
            --border: #e5e5e5;
            --border2: #d4d4d4;
            --text: #0a0a0a;
            --text2: #737373;
            --text3: #a3a3a3;
            --green: #22c55e;
            --green-bg: #f0fdf4;
            --green-border: #bbf7d0;
            --cyan: #06b6d4;
            --yellow: #eab308;
            --yellow-bg: #fefce8;
            --yellow-border: #fde68a;
            --red: #ef4444;
            --red-bg: #fef2f2;
            --red-border: #fecaca;
            --mono: 'JetBrains Mono', monospace;
            --sans: 'Inter', -apple-system, sans-serif;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:var(--sans); background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }

        /* NAV ‚Äî matches protocol page */
        nav {
            position:sticky; top:0; z-index:100; background:#fff;
            border-bottom:1px solid var(--border); height:60px;
            display:flex; align-items:center; justify-content:space-between;
            padding:0 32px;
        }
        .nav-brand { font-size:18px; font-weight:900; color:#0a0a0a; text-decoration:none; letter-spacing:-0.5px; }
        .nav-brand span { font-style:italic; }
        .nav-links { display:flex; align-items:center; gap:32px; }
        .nav-links a { color:var(--text2); text-decoration:none; font-size:14px; font-weight:500; transition:color .15s; }
        .nav-links a:hover { color:var(--text); }
        .nav-links a.active { color:var(--text); font-weight:700; }
        .nav-badge {
            display:inline-flex; align-items:center; gap:6px;
            background:#0a0a0a; color:#fff; padding:6px 14px;
            border-radius:100px; font-size:12px; font-weight:600;
            font-family:var(--mono);
        }
        .nav-badge .dot { width:6px; height:6px; border-radius:50%; background:var(--green); }

        .wrap { max-width:1100px; margin:0 auto; padding:48px 32px 80px; }

        /* HERO ‚Äî matches protocol page italic bold */
        .hero { text-align:center; margin-bottom:48px; }
        .hero h1 {
            font-size:42px; font-weight:900; font-style:italic;
            color:var(--text); letter-spacing:-2px; line-height:1.1;
            margin-bottom:10px;
        }
        .hero p { color:var(--text2); font-size:14px; }

        /* ALERT */
        .alert { border-radius:10px; padding:12px 18px; margin-bottom:36px; display:flex; align-items:center; gap:8px; font-size:14px; font-weight:500; }
        .a-ok { background:var(--green-bg); border:1px solid var(--green-border); color:#15803d; }
        .a-warn { background:var(--yellow-bg); border:1px solid var(--yellow-border); color:#a16207; }
        .a-crit { background:var(--red-bg); border:1px solid var(--red-border); color:#dc2626; }

        /* SECTION LABEL */
        .lbl { font-size:11px; text-transform:uppercase; letter-spacing:2px; color:var(--text3); font-weight:700; margin-bottom:16px; }

        /* GRIDS */
        .g5 { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-bottom:32px; }
        .g4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:32px; }
        .g2 { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:32px; }

        /* CARD ‚Äî matches protocol page exactly */
        .c {
            background:var(--surface); border:1px solid var(--border);
            border-radius:12px; padding:22px; transition:border-color .15s;
        }
        .c:hover { border-color:var(--border2); }
        .c-lbl { font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text3); font-weight:700; margin-bottom:8px; }
        .c-val {
            font-size:26px; font-weight:800; color:var(--text);
            font-family:var(--mono); letter-spacing:-1px; line-height:1.2;
        }
        .c-val.sm { font-size:20px; }
        .c-sub { font-size:12px; color:var(--text3); margin-top:4px; }
        .c-green { color:#16a34a !important; }
        .c-cyan { color:#0891b2 !important; }
        .c-yellow { color:#a16207 !important; }
        .c-red { color:#dc2626 !important; }

        /* RANGE VIS */
        .rv {
            background:var(--surface); border:1px solid var(--border);
            border-radius:14px; padding:28px; margin-bottom:32px;
        }
        .rv-hd { display:flex; justify-content:space-between; align-items:center; margin-bottom:22px; }
        .rv-tt { font-size:16px; font-weight:800; color:var(--text); }
        .rv-tg {
            font-size:11px; font-family:var(--mono); font-weight:700;
            background:var(--green-bg); color:#16a34a; padding:5px 12px;
            border-radius:6px; border:1px solid var(--green-border);
        }
        .rv-bar { position:relative; height:8px; background:#f5f5f5; border-radius:4px; margin:30px 0 24px; }
        .rv-z { position:absolute; height:100%; }
        .rv-zl { left:0; width:10%; background:rgba(234,179,8,.12); border-radius:4px 0 0 4px; }
        .rv-zc { left:10%; width:80%; background:rgba(34,197,94,.08); }
        .rv-zr { right:0; width:10%; background:rgba(234,179,8,.12); border-radius:0 4px 4px 0; }
        .rv-cur {
            position:absolute; top:-8px; width:3px; height:24px;
            background:var(--text); border-radius:2px;
            transition:left 1s cubic-bezier(.16,1,.3,1);
        }
        .rv-cur span {
            position:absolute; bottom:calc(100% + 6px); left:50%; transform:translateX(-50%);
            font-size:11px; font-family:var(--mono); font-weight:700;
            color:var(--text); white-space:nowrap;
            background:#f5f5f5; padding:2px 8px; border-radius:4px;
        }
        .rv-ends { display:flex; justify-content:space-between; font-size:12px; font-family:var(--mono); color:var(--text2); }
        .rv-ends small { display:block; font-size:11px; color:var(--text3); margin-top:2px; }
        .rv-info {
            display:flex; gap:20px; flex-wrap:wrap; padding:12px 16px;
            background:#fafafa; border-radius:8px; margin-top:18px;
            font-size:12px; font-family:var(--mono); color:var(--text2);
        }
        .rv-info em { color:var(--green); font-style:normal; font-weight:700; }

        /* PANELS */
        .pan-tt { font-size:14px; font-weight:800; color:var(--text); margin-bottom:14px; }
        .pan-r { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1px solid #f0f0f0; font-size:13px; }
        .pan-r:last-child { border-bottom:none; }
        .pan-r .k { color:var(--text2); }
        .pan-r .v { color:var(--text); font-weight:700; font-family:var(--mono); font-size:12px; }

        /* FORMULA */
        .fm {
            background:#fafafa; border-left:3px solid var(--text);
            border-radius:0 8px 8px 0; padding:16px 20px; margin-top:18px;
            font-family:var(--mono); font-size:12px; line-height:2; color:var(--text2);
        }
        .fm strong { color:var(--text); }

        /* ACTION PANEL */
        .act {
            background:var(--surface); border:1px solid var(--border);
            border-radius:14px; padding:28px; margin-bottom:32px;
            position:relative; overflow:hidden;
        }
        .act::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--text); }
        .act-title { font-size:16px; font-weight:800; color:var(--text); margin-bottom:5px; }
        .act-sub { font-size:13px; color:var(--text2); margin-bottom:24px; }
        .act-steps { display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }
        .act-step { background:#fafafa; border-radius:10px; padding:20px; }
        .act-num {
            display:inline-flex; align-items:center; justify-content:center;
            width:24px; height:24px; border-radius:50%;
            background:var(--text); color:#fff; font-size:12px;
            font-weight:800; margin-bottom:12px;
        }
        .act-step h4 { font-size:13px; font-weight:800; color:var(--text); margin-bottom:8px; }
        .act-step p { font-size:12px; color:var(--text2); line-height:1.5; margin-bottom:12px; }
        .act-btn {
            display:inline-flex; align-items:center; gap:5px; padding:10px 18px;
            border-radius:8px; font-size:13px; font-weight:700;
            text-decoration:none; cursor:pointer; border:none; transition:all .15s;
        }
        .act-btn-primary { background:var(--text); color:#fff; }
        .act-btn-primary:hover { opacity:.85; }
        .act-btn-danger { background:var(--red-bg); border:1px solid var(--red-border); color:var(--red); }
        .act-btn-danger:hover { background:#fecaca; }
        .act-vals { display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
        .act-val-row {
            display:flex; align-items:center; justify-content:space-between;
            background:#fff; border:1px solid var(--border); border-radius:8px; padding:8px 12px;
        }
        .act-val-row .label { font-size:10px; color:var(--text3); font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
        .act-val-row .value { font-size:13px; font-family:var(--mono); color:var(--text); font-weight:700; }
        .copy-btn { background:none; border:none; cursor:pointer; font-size:14px; padding:2px 6px; border-radius:4px; }
        .copy-btn:hover { background:#f0f0f0; }
        .copied { color:var(--green); font-size:11px; font-weight:700; }

        /* TIMELINE */
        .tl { position:relative; padding-left:28px; margin:20px 0; }
        .tl::before { content:''; position:absolute; left:9px; top:0; height:100%; width:2px; background:linear-gradient(180deg,var(--green),var(--yellow),var(--red),var(--green)); border-radius:1px; }
        .tl-i { position:relative; margin-bottom:20px; }
        .tl-i::before { content:''; position:absolute; left:-23px; top:5px; width:10px; height:10px; border-radius:50%; }
        .tl-i.g::before { background:var(--green); }
        .tl-i.y::before { background:var(--yellow); }
        .tl-i.o::before { background:var(--red); opacity:.6; }
        .tl-i.r::before { background:var(--red); }
        .tl-t { font-size:13px; font-weight:700; color:var(--text); margin-bottom:2px; }
        .tl-d { font-size:12px; color:var(--text3); }
        .tl-tag { display:inline-block; font-size:10px; font-family:var(--mono); background:#f5f5f5; color:var(--text3); padding:2px 7px; border-radius:3px; margin-left:4px; font-weight:700; }

        /* METHOD */
        .meth { font-size:14px; line-height:1.85; color:var(--text2); }
        .meth code { background:#f5f5f5; color:var(--text); padding:1px 5px; border-radius:3px; font-family:var(--mono); font-size:12px; font-weight:600; }

        /* FOOTER */
        footer { border-top:1px solid var(--border); padding:40px 32px 28px; max-width:1100px; margin:0 auto; }
        .ft-grid { display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:40px; margin-bottom:24px; }
        .ft-brand { font-size:16px; font-weight:900; color:var(--text); margin-bottom:8px; font-style:italic; }
        .ft-desc { font-size:13px; color:var(--text3); line-height:1.6; }
        .ft-col h4 { font-size:10px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text3); margin-bottom:10px; font-weight:700; }
        .ft-col a { display:block; font-size:13px; color:var(--text2); text-decoration:none; margin-bottom:7px; }
        .ft-col a:hover { color:var(--text); }
        .ft-bot { font-size:11px; color:var(--text3); text-align:center; padding-top:16px; border-top:1px solid var(--border); }

        @media(max-width:768px) {
            nav { padding:0 20px; } .nav-links { gap:16px; }
            .hero h1 { font-size:32px; }
            .g5,.g4 { grid-template-columns:repeat(2,1fr); }
            .g2 { grid-template-columns:1fr; }
            .act-steps { grid-template-columns:1fr; }
            .ft-grid { grid-template-columns:1fr 1fr; }
        }
        @media(max-width:480px) { .g5,.g4 { grid-template-columns:1fr; } .ft-grid { grid-template-columns:1fr; } }
    </style>
</head>
<body>

<nav>
    <a href="/" class="nav-brand"><span>efixDI+</span></a>
    <div class="nav-links">
        <a href="/app">App</a>
        <a href="/protocol">Protocol</a>
        <a href="/range-monitor" class="active">Range Monitor</a>
        <a href="/#contracts">Contracts</a>
        <div class="nav-badge"><span class="dot"></span><span id="navBlock">Mainnet</span></div>
    </div>
</nav>

<div class="wrap">
    <div class="hero">
        <h1>Range Monitor</h1>
        <p>Real-time Uniswap V3 position tracking, GBM range optimization & rebalancing alerts</p>
    </div>

    <div class="alert a-ok" id="aBar">
        <span id="aIcon">‚è≥</span>
        <span id="aText">Loading on-chain data...</span>
    </div>

    <div class="lbl">Position Overview</div>
    <div class="g5">
        <div class="c"><div class="c-lbl">efixDI Price</div><div class="c-val" id="price">‚Äî</div><div class="c-sub" id="fx">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Range Utilization</div><div class="c-val c-green" id="util">‚Äî</div><div class="c-sub" id="dir">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Est. Days to Exit</div><div class="c-val c-cyan" id="days">‚Äî</div><div class="c-sub">First Passage Time</div></div>
        <div class="c"><div class="c-lbl">Capital Efficiency</div><div class="c-val" id="eff">‚Äî</div><div class="c-sub" id="effS">vs full-range LP</div></div>
        <div class="c"><div class="c-lbl">Token Holders</div><div class="c-val" id="holders">‚Äî</div><div class="c-sub">Polygon + Base</div></div>
    </div>

    <div class="rv">
        <div class="rv-hd">
            <div class="rv-tt">Position in Range</div>
            <div class="rv-tg" id="nftTag">NFT #2847354</div>
        </div>
        <div class="rv-bar">
            <div class="rv-z rv-zl"></div>
            <div class="rv-z rv-zc"></div>
            <div class="rv-z rv-zr"></div>
            <div class="rv-cur" id="cur" style="left:50%"><span id="curL">‚Äî</span></div>
        </div>
        <div class="rv-ends">
            <div><span id="lo">‚Äî</span><small id="loFx">‚Äî</small></div>
            <div style="text-align:center;color:var(--text3);font-size:11px">‚óÑ BRL weakens ¬∑ Safe Zone ¬∑ BRL strengthens ‚ñ∫</div>
            <div style="text-align:right"><span id="hi">‚Äî</span><small id="hiFx">‚Äî</small></div>
        </div>
        <div class="rv-info">
            <div>Pool: <em>efixDI/USDC</em></div>
            <div>Fee: <em>0.01%</em></div>
            <div>Network: <em>Polygon</em></div>
            <div>Block: <em id="blk">#‚Äî</em></div>
            <div>Updated: <em id="upd">‚Äî</em></div>
        </div>
    </div>

    <div class="lbl">Liquidity Strategy</div>
    <div class="g2">
        <div class="c">
            <div class="pan-tt">‚óà Active Strategy</div>
            <div class="pan-r"><span class="k">Model</span><span class="v">GBM + First Passage</span></div>
            <div class="pan-r"><span class="k">Confidence</span><span class="v">95%</span></div>
            <div class="pan-r"><span class="k">Horizon</span><span class="v">30 days</span></div>
            <div class="pan-r"><span class="k">Annualized Vol</span><span class="v">10.5%</span></div>
            <div class="pan-r"><span class="k">Period Vol</span><span class="v" id="pvol">3.01%</span></div>
            <div class="pan-r"><span class="k">Z-Score</span><span class="v">1.96</span></div>
        </div>
        <div class="c">
            <div class="pan-tt">üîÑ Optimal Range (live)</div>
            <div class="pan-r"><span class="k">Suggested Lower</span><span class="v" id="oL">‚Äî</span></div>
            <div class="pan-r"><span class="k">Suggested Upper</span><span class="v" id="oU">‚Äî</span></div>
            <div class="pan-r"><span class="k">FX Range</span><span class="v" id="oFx">‚Äî</span></div>
            <div class="pan-r"><span class="k">Width</span><span class="v" id="oW">‚Äî</span></div>
            <div class="pan-r"><span class="k">Efficiency (if applied)</span><span class="v" id="oE">‚Äî</span></div>
            <div class="pan-r"><span class="k">Est. next rebalance</span><span class="v" id="oR">‚Äî</span></div>
        </div>
    </div>
    <div class="fm">
        <strong>Range:</strong> P = P_spot √ó exp(¬±z √ó œÉ √ó ‚àö(T/365))&nbsp;&nbsp;|&nbsp;&nbsp;<strong>FPT:</strong> E[œÑ] ‚âà (barrier / œÉ_daily)¬≤&nbsp;&nbsp;|&nbsp;&nbsp;z=1.96, œÉ=10.5%, T=30d
    </div>

    <div style="margin-top:40px"></div>
    <div class="lbl">‚ö° Rebalance Position</div>
    <div class="act">
        <div class="act-title">Rebalance when the range is consumed</div>
        <div class="act-sub">Position is concentrated and healthy. Rebalance when utilization reaches 90%+.</div>
        <div class="act-steps">
            <div class="act-step">
                <div class="act-num">1</div>
                <h4>Remove Liquidity</h4>
                <p>Remove 100% of liquidity from the current position #2847354.</p>
                <a class="act-btn act-btn-danger" href="https://app.uniswap.org/positions/v3/polygon/2847354" target="_blank">
                    Remove on Uniswap ‚Üó
                </a>
            </div>
            <div class="act-step">
                <div class="act-num">2</div>
                <h4>Copy Optimal Range</h4>
                <p>Set these as min/max price when creating the new position:</p>
                <div class="act-vals">
                    <div class="act-val-row">
                        <div>
                            <div class="label">Min Price (Lower)</div>
                            <div class="value" id="copyLo">‚Äî</div>
                        </div>
                        <button class="copy-btn" onclick="copyVal('copyLo')" title="Copy">üìã</button>
                    </div>
                    <div class="act-val-row">
                        <div>
                            <div class="label">Max Price (Upper)</div>
                            <div class="value" id="copyHi">‚Äî</div>
                        </div>
                        <button class="copy-btn" onclick="copyVal('copyHi')" title="Copy">üìã</button>
                    </div>
                </div>
                <div style="font-size:11px;color:var(--text3)">Values update live</div>
            </div>
            <div class="act-step">
                <div class="act-num">3</div>
                <h4>Create New Position</h4>
                <p>New Position ‚Üí efixDI + USDC ‚Üí 0.01% fee ‚Üí Paste range from Step 2.</p>
                <a class="act-btn act-btn-primary" id="newPosLink" href="https://app.uniswap.org/pool?chain=polygon" target="_blank">
                    New Position on Uniswap ‚Üó
                </a>
                <div style="font-size:11px;color:var(--text3);margin-top:8px">Gas: ~$0.02</div>
            </div>
        </div>
    </div>

    <div style="margin-top:40px"></div>
    <div class="lbl">Rebalancing Timeline</div>
    <div class="g4">
        <div class="c"><div class="c-lbl">Rebal / Month</div><div class="c-val sm c-cyan" id="rbM">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Rebal / Year</div><div class="c-val sm c-cyan" id="rbY">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Time per Rebal</div><div class="c-val sm">~5min</div></div>
        <div class="c"><div class="c-lbl">Cost (gas)</div><div class="c-val sm">~$0.02</div></div>
    </div>
    <div class="tl">
        <div class="tl-i g"><div class="tl-t">Position opened <span class="tl-tag">Day 0</span></div><div class="tl-d">Range set, monitor active.</div></div>
        <div class="tl-i y"><div class="tl-t" style="color:var(--yellow)">‚ö† Warning 75% <span class="tl-tag" id="tw">~Day ?</span></div><div class="tl-d">Monitor closely.</div></div>
        <div class="tl-i o"><div class="tl-t" style="color:var(--red);opacity:.7">üî∂ Critical 90% <span class="tl-tag" id="tc">~Day ?</span></div><div class="tl-d">Prepare new position.</div></div>
        <div class="tl-i r"><div class="tl-t" style="color:var(--red)">üö® Out of Range <span class="tl-tag" id="te">~Day ?</span></div><div class="tl-d">Rebalance NOW.</div></div>
        <div class="tl-i g"><div class="tl-t">‚úÖ Reset <span class="tl-tag">New cycle</span></div><div class="tl-d">Recalculated range applied.</div></div>
    </div>

    <div style="margin-top:40px"></div>
    <div class="lbl">Methodology</div>
    <div class="meth">
        <p>Range calculated via <code>Geometric Brownian Motion</code> (Black-Scholes framework), projecting
        price bounds at 95% confidence over 30 days using BRL/USD implied volatility (œÉ ‚âà 10.5% ann.).
        Rebalancing frequency via <code>First Passage Time</code>. All data read on-chain from Polygon
        via <code>slot0()</code> ‚Äî zero backend, zero API keys.</p>
    </div>
</div>

<footer>
    <div class="ft-grid">
        <div><div class="ft-brand">efixDI+</div><div class="ft-desc">Bridging Brazilian fixed-income into DeFi. CVM-regulated.</div></div>
        <div class="ft-col"><h4>Protocol</h4><a href="https://app.morpho.org/base/vault/0xf4A3FaDcEf350B2F168F97Cdbaa2221FF29ACBd5" target="_blank">Morpho Vault</a><a href="https://polygonscan.com/address/0x04082b283818D9d0dd9Ee8742892eEe5CC396441" target="_blank">Token (Polygon)</a><a href="https://app.uniswap.org/positions/v3/polygon/2847354" target="_blank">Uniswap Position</a></div>
        <div class="ft-col"><h4>Resources</h4><a href="./efixDI_Whitepaper_v1.pdf">Whitepaper</a><a href="https://github.com/Ernesto711/efix-pr-repo" target="_blank">GitHub</a></div>
        <div class="ft-col"><h4>Contact</h4><a href="mailto:contato@efix.com.br">contato@efix.com.br</a><a>Rio de Janeiro, Brazil</a></div>
    </div>
    <div class="ft-bot">¬© 2026 Efix Securitizadora S.A. ¬∑ CNPJ 60.756.859/0001-57 ¬∑ CVM Act 23.635/2025</div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
<script>
(function(){
    const C = {
        pid:2847354,
        nft:'0xC36442b4a4522E871399CD717aBDD847Ab11FE88',
        fac:'0x1F98431c8aD98523631AE4a59f267346ea31F984',
        efixDI:'0x04082b283818D9d0dd9Ee8742892eEe5CC396441',
        efixDI_base:'0xF5cA55f3ea5Bcd180aEa6dF9E05a0E63A66f5608',
        rpcs:['https://polygon-bor-rpc.publicnode.com','https://polygon.drpc.org','https://1rpc.io/matic','https://polygon.meowrpc.com'],
        rpcs_base:['https://base-rpc.publicnode.com','https://base.drpc.org','https://1rpc.io/base'],
        ms:30000, z:1.96, vol:0.105, days:30,
    };

    const NABI=['function positions(uint256) external view returns (uint96, address, address, address, uint24, int24, int24, uint128, uint256, uint256, uint128, uint128)'];
    const FABI=['function getPool(address,address,uint24) external view returns (address)'];
    const PABI=['function slot0() external view returns (uint160, int24, uint16, uint16, uint16, uint8, bool)'];


    function s2p(sqrtPX96) { const s=Number(sqrtPX96)/(2**96); return s*s*1e12; }
    function t2p(tick) { return Math.exp(tick*Math.log(1.0001))*1e12; }
    function gbm(p,v,d,z) { const pv=v*Math.sqrt(d/365),lo=p*Math.exp(-z*pv),hi=p*Math.exp(z*pv); return {lo,hi,pv,eff:Math.sqrt(p)/(Math.sqrt(hi)-Math.sqrt(lo))}; }
    function fpt(v,b) { return Math.pow(Math.max(b,0.0001)/(v/Math.sqrt(365)),2); }
    function isFullRange(tL,tU) { return tL<-800000&&tU>800000; }

    async function gp(rpcs) {
        for (const u of rpcs) try { const p=new ethers.JsonRpcProvider(u); await p.getBlockNumber(); return p; } catch{continue;}
        throw new Error('RPCs failed');
    }
    const $=id=>document.getElementById(id);

    // Fetch holder count ‚Äî approach: get all mint events (from=0x0), collect recipients, check balances
    async function fetchHolders() {
        let allHolders = new Set();
        
        async function scanChain(apiBase, contract, rpcs, label) {
            const recipients = new Set();
            try {
                // 1. Get all token transfers FROM the token contract (mints)
                const url = apiBase + '/api?module=account&action=tokentx' +
                    '&address=' + contract + '&startblock=0&endblock=99999999&sort=asc';
                const resp = await fetch(url);
                const data = await resp.json();
                console.log('[Holders] ' + label + ' tokentx:', data.status, data.message, 'results:', Array.isArray(data.result) ? data.result.length : typeof data.result);
                if (Array.isArray(data.result)) {
                    for (const tx of data.result) {
                        if (tx.to && tx.to !== '0x0000000000000000000000000000000000000000') recipients.add(tx.to.toLowerCase());
                        if (tx.from && tx.from !== '0x0000000000000000000000000000000000000000') recipients.add(tx.from.toLowerCase());
                    }
                }
            } catch(e) { console.log('[Holders] ' + label + ' tokentx error:', e.message); }

            // 2. Add known protocol addresses
            const known = [
                '0x7C54a68F11315EE3e3B4e4C7537a686dfaE47537',
                '0x2eA512b4C5e53A8c1302AC8ba2d43c5DA90b307C',
                '0x603265754fDdd7FdE459CC6e6722bd526C1258Fc',
                '0x1d97f1adbf545F3C99d33A6a2166Ee423A78f4C3',
                '0xC36442b4a4522E871399CD717aBDD847Ab11FE88',
            ];
            known.forEach(a => recipients.add(a.toLowerCase()));
            console.log('[Holders] ' + label + ' unique addresses to check:', recipients.size);

            // 3. Check balances via RPC
            let count = 0;
            try {
                let provider = null;
                for (const rpc of rpcs) {
                    try { provider = new ethers.JsonRpcProvider(rpc); await provider.getBlockNumber(); break; }
                    catch { continue; }
                }
                if (provider) {
                    const token = new ethers.Contract(contract, ['function balanceOf(address) view returns (uint256)'], provider);
                    const checks = [...recipients].map(async addr => {
                        try {
                            const bal = await token.balanceOf(addr);
                            if (bal > 0n) { count++; allHolders.add(addr); }
                        } catch {}
                    });
                    await Promise.allSettled(checks);
                }
            } catch(e) { console.log('[Holders] ' + label + ' RPC error:', e.message); }
            console.log('[Holders] ' + label + ':', count, 'holders');
            return count;
        }

        const poly = await scanChain('https://api.polygonscan.com', C.efixDI, C.rpcs, 'Polygon');
        await new Promise(r => setTimeout(r, 2000));
        const base = await scanChain('https://api.basescan.org', C.efixDI_base, C.rpcs_base, 'Base');
        const total = allHolders.size;
        $('holders').textContent = total > 0 ? total : '‚Äî';
        $('holders').title = 'Polygon: ' + poly + ' ¬∑ Base: ' + base;
        console.log('[Holders] Total unique:', total);
    }

    async function fetchData() {
        const pv=await gp(C.rpcs), bn=await pv.getBlockNumber();
        const nft=new ethers.Contract(C.nft,NABI,pv), pos=await nft.positions(C.pid);
        const token0=pos[2],token1=pos[3],fee=Number(pos[4]);
        const tL=Number(pos[5]),tU=Number(pos[6]);
        const fac=new ethers.Contract(C.fac,FABI,pv), pa=await fac.getPool(token0,token1,fee);
        const pool=new ethers.Contract(pa,PABI,pv);
        const s0=await pool.slot0();
        const sqrtPX96=s0[0],tick=Number(s0[1]);
        const cp=s2p(sqrtPX96);
        console.log('[RM] tick:',tick,'tL:',tL,'tU:',tU,'price:',cp,'inRange:',tick>=tL&&tick<=tU);
        return {cp,tL,tU,tick,ir:tick>=tL&&tick<=tU,bn,full:isFullRange(tL,tU)};
    }

    function ui(d) {
        const full=d.full, o=gbm(d.cp,C.vol,C.days,C.z), optHalf=o.hi/d.cp-1, optFpt=fpt(C.vol,optHalf);

        $('price').textContent='$'+d.cp.toFixed(5);
        $('fx').textContent='‚âà R$'+(1/d.cp).toFixed(2)+'/USD';
        const nb=$('navBlock'); if(nb) nb.textContent='Mainnet ¬∑ Block '+d.bn.toLocaleString();

        const ue=$('util');
        if(full){ue.textContent='Full Range';ue.className='c-val sm c-cyan';$('dir').textContent='Concentrate for '+o.eff.toFixed(0)+'x efficiency';}
        else{
            const pL=t2p(d.tL),pU=t2p(d.tU);
            const logU=Math.abs(Math.log(d.cp/pL)-Math.log(pU/pL)*0.5)/(Math.log(pU/pL)*0.5);
            const u=Math.min(logU,1);
            ue.textContent=(u*100).toFixed(1)+'%';
            ue.className='c-val '+(u>.9?'c-red':u>.75?'c-yellow':'c-green');
            $('dir').textContent=d.tick>(d.tL+d.tU)/2?'‚Üí Upper':'‚Üê Lower';
        }

        const de=$('days'),ee=$('eff');
        if(full){de.textContent='‚àû';de.className='c-val sm c-green';ee.textContent='1.0x';$('effS').textContent='Full range';}
        else{
            const pL=t2p(d.tL),pU=t2p(d.tU);
            const halfW=Math.abs(Math.log(pU/d.cp));
            const dte=fpt(C.vol,Math.exp(halfW)-1);
            de.textContent='~'+Math.round(dte)+'d';de.className='c-val sm '+(dte<7?'c-red':dte<21?'c-yellow':'c-cyan');
            const eff=Math.sqrt(d.cp)/(Math.sqrt(pU)-Math.sqrt(pL));
            ee.textContent=eff.toFixed(1)+'x';
        }

        $('rbM').textContent=full?'0':(30/optFpt<1?'<1':'~'+(30/optFpt).toFixed(1));
        $('rbY').textContent=full?'0':'~'+Math.round(365/optFpt);

        if(full){$('cur').style.left='50%';$('lo').textContent='MIN';$('loFx').textContent='tick '+d.tL;$('hi').textContent='MAX';$('hiFx').textContent='tick +'+d.tU;$('nftTag').textContent='NFT #2847354 ¬∑ FULL';}
        else{
            const pL=t2p(d.tL),pU=t2p(d.tU);
            const logP=(Math.log(d.cp)-Math.log(pL))/(Math.log(pU)-Math.log(pL));
            $('cur').style.left=Math.max(2,Math.min(98,logP*100))+'%';
            $('lo').textContent='$'+pL.toFixed(5);$('loFx').textContent='‚âà R$'+(1/pL).toFixed(2)+'/USD';
            $('hi').textContent='$'+pU.toFixed(5);$('hiFx').textContent='‚âà R$'+(1/pU).toFixed(2)+'/USD';
        }
        $('curL').textContent='$'+d.cp.toFixed(5);
        $('blk').textContent='#'+d.bn.toLocaleString();
        $('upd').textContent=new Date().toLocaleTimeString('pt-BR');
        // Update status (no separate live badge in this design)

        const ab=$('aBar'),at=$('aText'),ai=$('aIcon');
        if(!d.ir){ab.className='alert a-crit';ai.textContent='üö®';at.innerHTML='<strong>OUT OF RANGE</strong> ‚Äî Rebalancing needed.';}
        else if(full){ab.className='alert a-ok';ai.textContent='üì°';at.innerHTML='Full-range position. Apply concentrated range for <strong>'+o.eff.toFixed(0)+'x</strong> efficiency.';}
        else{
            const pL=t2p(d.tL),pU=t2p(d.tU);
            const u=Math.min(Math.abs(Math.log(d.cp/pL)-Math.log(pU/pL)*0.5)/(Math.log(pU/pL)*0.5),1);
            if(u>=.9){ab.className='alert a-crit';ai.textContent='üî∂';at.innerHTML='<strong>CRITICAL</strong> ‚Äî '+(u*100).toFixed(0)+'% used.';}
            else if(u>=.75){ab.className='alert a-warn';ai.textContent='‚ö†';at.innerHTML='<strong>WARNING</strong> ‚Äî '+(u*100).toFixed(0)+'% consumed.';}
            else{ab.className='alert a-ok';ai.textContent='‚úÖ';at.innerHTML='Healthy ‚Äî '+(u*100).toFixed(0)+'% used. ~'+Math.round(fpt(C.vol,Math.exp(Math.abs(Math.log(pU/d.cp)))-1))+'d until exit.';}
        }

        $('oL').textContent='$'+o.lo.toFixed(5);$('oU').textContent='$'+o.hi.toFixed(5);
        $('oFx').textContent='R$'+(1/o.hi).toFixed(2)+'‚Äì'+(1/o.lo).toFixed(2);
        $('oW').textContent='¬±'+(optHalf*100).toFixed(1)+'%';$('oE').textContent=o.eff.toFixed(1)+'x';
        $('pvol').textContent=(o.pv*100).toFixed(2)+'%';$('oR').textContent='~'+Math.round(optFpt)+'d';
        $('tw').textContent='~Day '+Math.round(fpt(C.vol,optHalf*.75));
        $('tc').textContent='~Day '+Math.round(fpt(C.vol,optHalf*.90));
        $('te').textContent='~Day '+Math.round(optFpt);
        $('copyLo').textContent=o.lo.toFixed(5);$('copyHi').textContent=o.hi.toFixed(5);
        $('newPosLink').href='https://app.uniswap.org/pool?chain=polygon';

        const actSub=document.querySelector('.act-sub');
        if(actSub){
            if(full)actSub.textContent='Full-range ‚Äî concentrate for '+o.eff.toFixed(0)+'x efficiency.';
            else{
                const pL=t2p(d.tL),pU=t2p(d.tU);
                const u=Math.min(Math.abs(Math.log(d.cp/pL)-Math.log(pU/pL)*0.5)/(Math.log(pU/pL)*0.5),1);
                actSub.textContent=u>=.75?'Utilization at '+(u*100).toFixed(0)+'% ‚Äî consider rebalancing soon.':'Position is concentrated and healthy. Rebalance when utilization reaches 90%+.';
            }
        }
    }

    async function go(){try{ui(await fetchData());}catch(e){console.error('[RM]',e);}}
    go(); setInterval(go,C.ms);
    setTimeout(fetchHolders, 2000); // Run after main data loads
})();

function copyVal(id){
    const el=document.getElementById(id),val=el.textContent;
    navigator.clipboard.writeText(val).then(()=>{
        const btn=el.closest('.act-val-row').querySelector('.copy-btn');
        const orig=btn.textContent;btn.innerHTML='<span class="copied">‚úì</span>';
        setTimeout(()=>{btn.textContent=orig||'üìã';},1500);
    }).catch(()=>{const ta=document.createElement('textarea');ta.value=val;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);});
}
</script>
</body>
</html>
