<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Range Monitor ‚Äî efixDI/USDC | EFIX Protocol</title>
    <meta name="description" content="Live Uniswap V3 liquidity range monitor for efixDI/USDC on Polygon.">
    <meta property="og:title" content="efixDI Range Monitor ‚Äî EFIX Protocol">
    <meta property="og:description" content="Live Uniswap V3 position monitoring with GBM range optimization. Polygon Mainnet.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://efix.finance/range-monitor">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚óà</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        header { text-align: center; margin-bottom: 60px; }
        h1 {
            font-size: 3em; font-weight: 800;
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 10px;
        }
        .subtitle { color: #888; font-size: 1.2em; }
        .live-indicator {
            display: inline-flex; align-items: center; gap: 8px; margin-top: 15px;
            padding: 6px 16px; background: rgba(0,255,136,0.08);
            border: 1px solid rgba(0,255,136,0.25); border-radius: 20px;
            font-size: 0.85em; color: #00ff88; font-weight: 600;
        }
        .live-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #00ff88;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%,100% { opacity:1; box-shadow: 0 0 0 0 rgba(0,255,136,0.4); }
            50% { opacity:0.5; box-shadow: 0 0 0 8px rgba(0,255,136,0); }
        }
        .section {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 40px; margin-bottom: 40px;
            backdrop-filter: blur(10px);
        }
        h2 { color: #00ff88; margin-bottom: 25px; font-size: 2em; display: flex; align-items: center; gap: 15px; }
        .icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5em;
        }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 20px; margin-top: 30px; }
        .metric-card {
            background: rgba(0,255,136,0.05); border: 1px solid rgba(0,255,136,0.2);
            border-radius: 12px; padding: 20px; text-align: center; transition: transform 0.3s;
        }
        .metric-card:hover { transform: translateY(-3px); border-color: rgba(0,255,136,0.4); }
        .metric-value {
            font-size: 2em; font-weight: bold;
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .metric-value.warn { background: linear-gradient(135deg, #ff9800, #ffc107); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .metric-value.crit { background: linear-gradient(135deg, #ff5252, #ff8a80); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .metric-label { color: #888; margin-top: 5px; }
        .metric-sub { color: #555; font-size: 0.8em; margin-top: 3px; font-family: 'Courier New', monospace; }
        .alert-bar { border-radius: 12px; padding: 20px; margin-bottom: 40px; display: flex; align-items: center; gap: 12px; font-size: 1.05em; font-weight: 500; }
        .alert-ok { background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.25); color: #00ff88; }
        .alert-warn { background: linear-gradient(135deg, rgba(255,152,0,0.1), rgba(255,193,7,0.1)); border: 1px solid rgba(255,152,0,0.5); color: #ff9800; }
        .alert-crit { background: linear-gradient(135deg, rgba(255,82,82,0.1), rgba(255,138,128,0.1)); border: 1px solid rgba(255,82,82,0.5); color: #ff5252; }
        .alert-icon { font-size: 1.4em; }
        .range-visualizer { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 30px; margin: 30px 0; }
        .range-bar-outer { position: relative; height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; margin: 30px 0; }
        .range-zone-left { position: absolute; left:0; width: 12.5%; height: 100%; background: rgba(255,152,0,0.15); border-radius: 6px 0 0 6px; }
        .range-zone-mid { position: absolute; left: 12.5%; width: 75%; height: 100%; background: rgba(0,255,136,0.12); }
        .range-zone-right { position: absolute; right:0; width: 12.5%; height: 100%; background: rgba(255,152,0,0.15); border-radius: 0 6px 6px 0; }
        .range-cursor {
            position: absolute; top: -8px; width: 4px; height: 28px; background: #fff;
            border-radius: 2px; transition: left 0.8s cubic-bezier(0.16,1,0.3,1);
            box-shadow: 0 0 15px rgba(255,255,255,0.4);
        }
        .range-cursor-label {
            position: absolute; top: -28px; left: 50%; transform: translateX(-50%);
            font-size: 0.8em; font-family: 'Courier New', monospace; color: #fff; white-space: nowrap; font-weight: 600;
        }
        .range-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em; font-family: 'Courier New', monospace; color: #888; }
        .range-labels span { display: block; color: #555; font-size: 0.85em; margin-top: 2px; }
        .tech-stack { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: 20px; margin-top: 30px; }
        .tech-card {
            background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,204,255,0.1));
            border: 1px solid rgba(0,255,136,0.3); border-radius: 15px; padding: 25px;
            transition: transform 0.3s;
        }
        .tech-card:hover { transform: translateY(-5px); border-color: #00ff88; }
        .tech-title { color: #00ccff; font-weight: 600; margin-bottom: 10px; font-size: 1.1em; }
        .tech-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95em; }
        .tech-row:last-child { border-bottom: none; }
        .tech-row .k { color: #888; }
        .tech-row .v { color: #fff; font-weight: 600; font-family: 'Courier New', monospace; }
        .formula {
            background: rgba(0,0,0,0.5); border-left: 4px solid #00ff88;
            padding: 20px; margin: 20px 0; font-family: 'Courier New', monospace; border-radius: 8px; line-height: 1.9;
        }
        code { background: rgba(0,255,136,0.1); padding: 2px 8px; border-radius: 4px; font-family: 'Courier New', monospace; color: #00ff88; }
        .contract-spec { background: rgba(0,0,0,0.4); border-radius: 12px; padding: 25px; margin: 20px 0; font-family: 'Courier New', monospace; }
        .timeline { position: relative; padding-left: 40px; margin: 30px 0; }
        .timeline::before {
            content: ''; position: absolute; left: 15px; top: 0; height: 100%; width: 2px;
            background: linear-gradient(180deg, #00ff88 0%, #ff9800 50%, #ff5252 75%, #00ff88 100%);
        }
        .timeline-item { position: relative; margin-bottom: 30px; }
        .timeline-item::before {
            content: ''; position: absolute; left: -30px; top: 5px;
            width: 12px; height: 12px; border-radius: 50%;
        }
        .timeline-item.green::before { background: #00ff88; box-shadow: 0 0 20px rgba(0,255,136,0.5); }
        .timeline-item.yellow::before { background: #ff9800; box-shadow: 0 0 20px rgba(255,152,0,0.5); }
        .timeline-item.orange::before { background: #ff6d00; box-shadow: 0 0 20px rgba(255,109,0,0.5); }
        .timeline-item.red::before { background: #ff5252; box-shadow: 0 0 20px rgba(255,82,82,0.5); }
        .timeline-title { font-weight: 600; margin-bottom: 4px; }
        .timeline-desc { color: #888; font-size: 0.95em; }
        .timeline-tag {
            display: inline-block; background: rgba(255,255,255,0.05); padding: 2px 10px;
            border-radius: 4px; font-size: 0.8em; color: #666; font-family: 'Courier New', monospace; margin-left: 8px;
        }
        .warning {
            background: linear-gradient(135deg, rgba(255,152,0,0.1), rgba(255,193,7,0.1));
            border: 1px solid rgba(255,152,0,0.5); border-radius: 12px; padding: 20px; margin: 30px 0;
        }
        .warning-title { color: #ff9800; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .footer-links { text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.05); color: #555; font-size: 0.9em; }
        .footer-links a { color: #00ccff; text-decoration: none; }
        .footer-links a:hover { color: #00ff88; }
        @media (max-width: 768px) {
            h1 { font-size: 2em; } h2 { font-size: 1.5em; }
            .section { padding: 25px; } .metrics { grid-template-columns: repeat(2,1fr); }
            .tech-stack { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) { .metrics { grid-template-columns: 1fr; } .container { padding: 20px 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RANGE MONITOR</h1>
            <div class="subtitle">efixDI / USDC ¬∑ Uniswap V3 ¬∑ Polygon Mainnet ¬∑ 0.05% Fee Tier</div>
            <div class="live-indicator">
                <span class="live-dot"></span>
                <span id="liveStatus">Conectando ao RPC...</span>
            </div>
        </header>

        <div class="alert-bar alert-ok" id="alertBar">
            <span class="alert-icon">‚è≥</span>
            <span id="alertText">Carregando dados on-chain da Polygon...</span>
        </div>

        <!-- ‚îÄ‚îÄ POSI√á√ÉO ATUAL ‚îÄ‚îÄ -->
        <div class="section">
            <h2><span class="icon">üìä</span>Posi√ß√£o Atual</h2>
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="currentPrice">‚Äî</div>
                    <div class="metric-label">Pre√ßo efixDI</div>
                    <div class="metric-sub" id="impliedFx">‚Äî</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="utilization">‚Äî</div>
                    <div class="metric-label">Utiliza√ß√£o do Range</div>
                    <div class="metric-sub" id="direction">‚Äî</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="estDays">‚Äî</div>
                    <div class="metric-label">Est. Dias p/ Sair</div>
                    <div class="metric-sub">First Passage Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="efficiency">‚Äî</div>
                    <div class="metric-label">Efici√™ncia de Capital</div>
                    <div class="metric-sub">vs full-range LP</div>
                </div>
            </div>

            <div class="range-visualizer">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span style="color:#00ccff; font-weight:600;">Posi√ß√£o no Range</span>
                    <code>NFT #2847265</code>
                </div>
                <div class="range-bar-outer">
                    <div class="range-zone-left"></div>
                    <div class="range-zone-mid"></div>
                    <div class="range-zone-right"></div>
                    <div class="range-cursor" id="rangeCursor" style="left:50%">
                        <span class="range-cursor-label" id="cursorLabel">$0.1953</span>
                    </div>
                </div>
                <div class="range-labels">
                    <div><span id="lowerPrice">$0.0000</span><span id="lowerFx">‚Äî</span></div>
                    <div style="text-align:center; color:#555;">‚óÑ BRL‚Üì ¬∑ Zona Segura ¬∑ BRL‚Üë ‚ñ∫</div>
                    <div style="text-align:right;"><span id="upperPrice">$0.0000</span><span id="upperFx">‚Äî</span></div>
                </div>
            </div>

            <div class="contract-spec">
                <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:15px;">
                    <div>Pool: <span style="color:#00ff88;">efixDI/USDC</span></div>
                    <div>Fee: <span style="color:#00ff88;">0.05%</span></div>
                    <div>Rede: <span style="color:#00ff88;">Polygon</span></div>
                    <div>Bloco: <span style="color:#00ccff;" id="blockNumber">#‚Äî</span></div>
                    <div>Atualizado: <span style="color:#00ccff;" id="lastUpdate">‚Äî</span></div>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ ESTRAT√âGIA ‚îÄ‚îÄ -->
        <div class="section">
            <h2><span class="icon">üéØ</span>Estrat√©gia de Liquidez</h2>
            <p style="font-size:1.1em; line-height:1.8; margin-bottom:20px;">
                Range calculado via <code>Geometric Brownian Motion</code> ‚Äî o modelo estoc√°stico de 
                Black-Scholes ‚Äî projetando limites de pre√ßo com 95% de confian√ßa sobre 30 dias, 
                baseado na volatilidade impl√≠cita do BRL/USD.
            </p>
            <div class="tech-stack">
                <div class="tech-card">
                    <div class="tech-title">‚óà Estrat√©gia Ativa</div>
                    <div class="tech-row"><span class="k">Modelo</span><span class="v">GBM + First Passage</span></div>
                    <div class="tech-row"><span class="k">Confian√ßa</span><span class="v">95%</span></div>
                    <div class="tech-row"><span class="k">Horizonte</span><span class="v">30 dias</span></div>
                    <div class="tech-row"><span class="k">Vol Anualizada</span><span class="v">10.5%</span></div>
                    <div class="tech-row"><span class="k">Vol Per√≠odo</span><span class="v" id="volPeriod">3.01%</span></div>
                    <div class="tech-row"><span class="k">Z-Score</span><span class="v">1.96</span></div>
                </div>
                <div class="tech-card">
                    <div class="tech-title">üîÑ Range √ìtimo Atualizado</div>
                    <div class="tech-row"><span class="k">Lower sugerido</span><span class="v" id="optLower">‚Äî</span></div>
                    <div class="tech-row"><span class="k">Upper sugerido</span><span class="v" id="optUpper">‚Äî</span></div>
                    <div class="tech-row"><span class="k">FX Range</span><span class="v" id="optFx">‚Äî</span></div>
                    <div class="tech-row"><span class="k">Width</span><span class="v" id="optWidth">‚Äî</span></div>
                    <div class="tech-row"><span class="k">Efici√™ncia (novo)</span><span class="v" id="optEff">‚Äî</span></div>
                    <div class="tech-row"><span class="k">Pr√≥x. rebal (est.)</span><span class="v" id="optRebal">‚Äî</span></div>
                </div>
            </div>
            <div class="formula">
                <strong style="color:#00ff88;">F√≥rmula do Range:</strong><br><br>
                P_lower = P_spot √ó exp(-z √ó œÉ √ó ‚àö(T/365))<br>
                P_upper = P_spot √ó exp(+z √ó œÉ √ó ‚àö(T/365))<br><br>
                <strong style="color:#00ccff;">First Passage Time:</strong><br>
                E[œÑ] ‚âà (barrier / œÉ_daily)¬≤<br><br>
                <span style="color:#888;">Onde: z = 1.96 (95%), œÉ = 10.5% a.a., T = 30 dias<br>
                Efici√™ncia = ‚àöP / (‚àöP_upper - ‚àöP_lower)</span>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ TIMELINE DE ALERTAS ‚îÄ‚îÄ -->
        <div class="section">
            <h2><span class="icon">üîî</span>Timeline de Alertas</h2>
            <p style="font-size:1.1em; line-height:1.8; margin-bottom:20px;">
                O sistema monitora a posi√ß√£o e alerta conforme o pre√ßo se aproxima dos limites.
            </p>
            <div class="metrics" style="margin-bottom:30px;">
                <div class="metric-card">
                    <div class="metric-value" id="rebalMonth">‚Äî</div>
                    <div class="metric-label">Rebal / M√™s</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rebalYear">‚Äî</div>
                    <div class="metric-label">Rebal / Ano</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">~5min</div>
                    <div class="metric-label">Tempo por Rebal</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">~$0.02</div>
                    <div class="metric-label">Custo (gas Polygon)</div>
                </div>
            </div>
            <div class="timeline">
                <div class="timeline-item green">
                    <div class="timeline-title" style="color:#00ff88;">Posi√ß√£o aberta <span class="timeline-tag">Dia 0</span></div>
                    <div class="timeline-desc">Range definido, monitor ativo. Nenhuma a√ß√£o necess√°ria.</div>
                </div>
                <div class="timeline-item yellow">
                    <div class="timeline-title" style="color:#ff9800;">‚ö†Ô∏è Alerta Warning (75%) <span class="timeline-tag" id="tagWarning">~Dia ?</span></div>
                    <div class="timeline-desc">Pre√ßo consumiu 75% do range. Apenas observe.</div>
                </div>
                <div class="timeline-item orange">
                    <div class="timeline-title" style="color:#ff6d00;">üî∂ Alerta Cr√≠tico (90%) <span class="timeline-tag" id="tagCritical">~Dia ?</span></div>
                    <div class="timeline-desc">Prepare a nova posi√ß√£o. Calcule novo range √≥timo. Tenha a tx pronta.</div>
                </div>
                <div class="timeline-item red">
                    <div class="timeline-title" style="color:#ff5252;">üö® Fora do Range (100%) <span class="timeline-tag" id="tagExit">~Dia ?</span></div>
                    <div class="timeline-desc">Rebalancear AGORA: Remover liquidez ‚Üí Nova posi√ß√£o com range atualizado.</div>
                </div>
                <div class="timeline-item green">
                    <div class="timeline-title" style="color:#00ff88;">‚úÖ Nova posi√ß√£o <span class="timeline-tag">Reset</span></div>
                    <div class="timeline-desc">Ciclo recome√ßa com range recalculado pelo GBM no pre√ßo atual.</div>
                </div>
            </div>
            <div class="warning">
                <div class="warning-title">‚ö° Workflow de Rebalanceamento</div>
                <div style="color:#ccc; line-height:1.8;">
                    Recebe alerta ‚Üí Abre Uniswap ‚Üí Remove liquidez da posi√ß√£o #2847265 ‚Üí
                    Consulta o range √≥timo atualizado acima ‚Üí Cria nova posi√ß√£o com os novos limites ‚Üí Done.
                    Gas na Polygon custa centavos, impermanent loss √© desprez√≠vel porque o efixDI √© est√°vel em BRL.
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ METODOLOGIA ‚îÄ‚îÄ -->
        <div class="section">
            <h2><span class="icon">üìê</span>Metodologia</h2>
            <p style="font-size:1.05em; line-height:1.9; color:#bbb;">
                O <code>Geometric Brownian Motion</code> modela o pre√ßo efixDI/USDC como dependente do c√¢mbio BRL/USD,
                usando volatilidade impl√≠cita extra√≠da do range hist√≥rico dos √∫ltimos 6 meses (R$5.18‚Äì5.59, vol ‚âà 10.5% a.a.).
                A f√≥rmula projeta limites com intervalo de confian√ßa de 95% sobre 30 dias.
            </p>
            <p style="font-size:1.05em; line-height:1.9; color:#bbb; margin-top:15px;">
                A frequ√™ncia de rebalanceamento √© estimada via <code>First Passage Time</code> (teoria de processos estoc√°sticos),
                calculando o tempo esperado para um processo browniano atingir uma barreira pela primeira vez.
                Todos os dados s√£o lidos diretamente da blockchain Polygon via contratos
                <code>NonfungiblePositionManager</code> e <code>UniswapV3Pool.slot0()</code>,
                sem nenhum backend intermedi√°rio. Auto-refresh a cada 30 segundos.
            </p>
        </div>

        <div class="footer-links">
            EFIX Protocol ¬∑ Polygon Mainnet ¬∑ Position #2847265<br>
            <a href="https://app.uniswap.org/positions/v3/polygon/2847265" target="_blank">View on Uniswap ‚Üó</a> ¬∑
            <a href="https://polygonscan.com/token/0xC36442b4a4522E871399CD717aBDD847Ab11FE88" target="_blank">Contract ‚Üó</a> ¬∑
            <a href="https://efix.finance" target="_blank">efix.finance ‚Üó</a>
            <br><br>Auto-refresh 30s ¬∑ Data: on-chain Polygon RPC ¬∑ Zero backend
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
    <script>
    (function(){
        const C = {
            pid: 2847265,
            nft: '0xC36442b4a4522E871399CD717aBDD847Ab11FE88',
            fac: '0x1F98431c8aD98523631AE4a59f267346ea31F984',
            rpcs: ['https://polygon-rpc.com','https://polygon.llamarpc.com','https://rpc.ankr.com/polygon','https://polygon-mainnet.public.blastapi.io'],
            ms: 30000, z: 1.96, vol: 0.105, days: 30,
        };
        const NABI=['function positions(uint256) view returns (uint96,address,address,address,uint24,int24,int24,uint128,uint256,uint256,uint128,uint128)'];
        const FABI=['function getPool(address,address,uint24) view returns (address)'];
        const PABI=['function slot0() view returns (int24,uint160,uint16,uint16,uint16,uint8,bool)','function liquidity() view returns (uint128)'];

        const t2p=(t,d0=18,d1=6)=>Math.pow(1.0001,t)*Math.pow(10,d0-d1);
        const s2p=(s,d0=18,d1=6)=>{const x=Number(s)/(2**96);return x*x*Math.pow(10,d0-d1);};
        const gbm=(p,v,d,z)=>{const pv=v*Math.sqrt(d/365),l=p*Math.exp(-z*pv),u=p*Math.exp(z*pv);return{lower:l,upper:u,pVol:pv,eff:Math.sqrt(p)/(Math.sqrt(u)-Math.sqrt(l))};};
        const fpt=(v,b)=>{const dv=v/Math.sqrt(365);return Math.pow(b/dv,2);};

        async function gp(){for(const u of C.rpcs)try{const p=new ethers.JsonRpcProvider(u);await p.getBlockNumber();return p;}catch{continue;}throw new Error('RPC fail');}
        const $=id=>document.getElementById(id);

        async function fetch_(){
            const pv=await gp(), bn=await pv.getBlockNumber();
            const nft=new ethers.Contract(C.nft,NABI,pv), pos=await nft.positions(C.pid);
            const t0=pos[2],t1=pos[3],fee=Number(pos[4]),tL=Number(pos[5]),tU=Number(pos[6]);
            const fac=new ethers.Contract(C.fac,FABI,pv), pa=await fac.getPool(t0,t1,fee);
            const pool=new ethers.Contract(pa,PABI,pv),[s0,pl]=await Promise.all([pool.slot0(),pool.liquidity()]);
            const ct=Number(s0[0]),sp=s0[1];
            const cp=s2p(sp),pL=t2p(tL),pU=t2p(tU);
            const mid=(pU+pL)/2, hw=(pU-pL)/2;
            return{cp,pL,pU,ct,tL,tU,pl:pl.toString(),ut:(cp-mid)/hw,ir:ct>=tL&&ct<=tU,bn};
        }

        function ui(d){
            const au=Math.abs(d.ut), dir=d.ut>0?'‚Üí Upper (BRL‚Üë)':'‚Üê Lower (BRL‚Üì)', rw=d.pU-d.pL;
            $('currentPrice').textContent='$'+d.cp.toFixed(5);
            $('impliedFx').textContent='‚âà R$'+(1/d.cp).toFixed(2)+'/USD';
            $('utilization').textContent=(au*100).toFixed(1)+'%';
            const ue=$('utilization');
            ue.className='metric-value'+(au>0.9?' crit':au>0.75?' warn':'');
            $('direction').textContent=dir;

            const dp=(1-au)*(rw/d.cp)/2, dte=fpt(C.vol,dp), eff=Math.sqrt(d.cp)/(Math.sqrt(d.pU)-Math.sqrt(d.pL));
            const ry=365/dte, rm=30/dte;
            $('estDays').textContent='~'+Math.round(dte)+'d';
            const de=$('estDays'); de.className='metric-value'+(dte<7?' crit':dte<21?' warn':'');
            $('efficiency').textContent=eff.toFixed(1)+'x';
            $('rebalMonth').textContent=rm<1?'<1':'~'+rm.toFixed(1);
            $('rebalYear').textContent='~'+Math.round(ry);

            const cp=Math.max(0,Math.min(100,((d.cp-d.pL)/rw)*100));
            $('rangeCursor').style.left=cp+'%';
            $('cursorLabel').textContent='$'+d.cp.toFixed(5);
            $('lowerPrice').textContent='$'+d.pL.toFixed(5);
            $('lowerFx').textContent='‚âà R$'+(1/d.pL).toFixed(2)+'/USD';
            $('upperPrice').textContent='$'+d.pU.toFixed(5);
            $('upperFx').textContent='‚âà R$'+(1/d.pU).toFixed(2)+'/USD';
            $('blockNumber').textContent='#'+d.bn.toLocaleString();
            $('lastUpdate').textContent=new Date().toLocaleTimeString('pt-BR');
            $('liveStatus').textContent=d.ir?'IN RANGE ¬∑ LIVE':'‚ö† OUT OF RANGE';

            const ab=$('alertBar'),at=$('alertText'),ai=ab.querySelector('.alert-icon');
            if(!d.ir){ab.className='alert-bar alert-crit';ai.textContent='üö®';at.innerHTML='<strong>FORA DO RANGE</strong> ‚Äî Rebalanceamento necess√°rio agora.';}
            else if(au>=0.9){ab.className='alert-bar alert-crit';ai.textContent='üî∂';at.innerHTML='<strong>ZONA CR√çTICA</strong> ‚Äî '+(au*100).toFixed(0)+'% do range. Prepare o rebalanceamento.';}
            else if(au>=0.75){ab.className='alert-bar alert-warn';ai.textContent='‚ö†Ô∏è';at.innerHTML='<strong>AVISO</strong> ‚Äî '+(au*100).toFixed(0)+'% do range consumido.';}
            else{ab.className='alert-bar alert-ok';ai.textContent='‚úÖ';at.innerHTML='Posi√ß√£o saud√°vel ‚Äî '+(au*100).toFixed(0)+'% do range utilizado.';}

            const o=gbm(d.cp,C.vol,C.days,C.z);
            $('optLower').textContent='$'+o.lower.toFixed(5);
            $('optUpper').textContent='$'+o.upper.toFixed(5);
            $('optFx').textContent='R$'+(1/o.upper).toFixed(2)+' ‚Äî R$'+(1/o.lower).toFixed(2);
            $('optWidth').textContent='¬±'+((o.upper/d.cp-1)*100).toFixed(1)+'%';
            $('optEff').textContent=o.eff.toFixed(1)+'x';
            $('volPeriod').textContent=(o.pVol*100).toFixed(2)+'%';
            const oh=o.upper/d.cp-1, of_=fpt(C.vol,oh);
            $('optRebal').textContent='~'+Math.round(of_)+'d';
            $('tagWarning').textContent='~Dia '+Math.round(fpt(C.vol,oh*0.75));
            $('tagCritical').textContent='~Dia '+Math.round(fpt(C.vol,oh*0.90));
            $('tagExit').textContent='~Dia '+Math.round(of_);
        }

        async function go(){try{ui(await fetch_());}catch(e){console.error(e);$('liveStatus').textContent='ERRO RPC ‚Äî retentando...';}}
        go(); setInterval(go,C.ms);
    })();
    </script>
</body>
</html>
