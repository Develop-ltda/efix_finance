<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Range Monitor ‚Äî efixDI/USDC | EFIX Protocol</title>
    <meta name="description" content="Live Uniswap V3 liquidity range monitor for efixDI/USDC on Polygon.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚óà</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafafa;
            --white: #ffffff;
            --surface: #ffffff;
            --surface2: #f4f4f5;
            --border: #e4e4e7;
            --border2: #d4d4d8;
            --text: #18181b;
            --text2: #52525b;
            --text3: #a1a1aa;
            --green: #16a34a;
            --green2: #22c55e;
            --green-bg: #f0fdf4;
            --green-border: #bbf7d0;
            --cyan: #0891b2;
            --cyan-bg: #ecfeff;
            --yellow: #ca8a04;
            --yellow-bg: #fefce8;
            --yellow-border: #fef08a;
            --red: #dc2626;
            --red-bg: #fef2f2;
            --red-border: #fecaca;
            --dark: #09090b;
            --mono: 'JetBrains Mono', monospace;
            --sans: 'Inter', -apple-system, sans-serif;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:var(--sans); background:var(--bg); color:var(--text); min-height:100vh; -webkit-font-smoothing:antialiased; }

        /* NAV ‚Äî dark bar like efix.finance */
        nav {
            position:sticky; top:0; z-index:100;
            background:var(--dark); height:64px;
            display:flex; align-items:center; justify-content:space-between; padding:0 40px;
        }
        .nav-brand { display:flex; align-items:center; gap:12px; text-decoration:none; }
        .nav-brand img { width:34px; height:34px; border-radius:8px; }
        .nav-links { display:flex; align-items:center; gap:28px; }
        .nav-links a { color:#a1a1aa; text-decoration:none; font-size:14px; font-weight:500; transition:color .2s; }
        .nav-links a:hover { color:#fff; }
        .nav-links a.active { color:#4ade80; }
        .nav-cta { background:linear-gradient(135deg,#22c55e,#06b6d4); color:#000; padding:8px 20px; border-radius:8px; font-weight:600; font-size:14px; text-decoration:none; }

        .wrap { max-width:1080px; margin:0 auto; padding:40px 24px 60px; }

        /* HERO */
        .hero { text-align:center; margin-bottom:40px; }
        .badge {
            display:inline-flex; align-items:center; gap:8px;
            background:var(--green-bg); border:1px solid var(--green-border);
            border-radius:100px; padding:5px 16px; margin-bottom:16px;
            font-size:13px; color:var(--green); font-weight:600;
        }
        .dot { width:7px; height:7px; border-radius:50%; background:var(--green2); animation:p 2s infinite; }
        @keyframes p { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4)} 50%{box-shadow:0 0 0 6px rgba(34,197,94,0)} }
        .hero h1 { font-size:40px; font-weight:800; letter-spacing:-1.5px; color:var(--text); margin-bottom:8px; }
        .hero h1 em { font-style:normal; background:linear-gradient(135deg,#22c55e,#06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .hero p { color:var(--text2); font-size:15px; line-height:1.6; }

        /* ALERT */
        .alert { border-radius:12px; padding:14px 20px; margin-bottom:32px; display:flex; align-items:center; gap:10px; font-size:14px; font-weight:500; }
        .a-ok { background:var(--green-bg); border:1px solid var(--green-border); color:var(--green); }
        .a-warn { background:var(--yellow-bg); border:1px solid var(--yellow-border); color:var(--yellow); }
        .a-crit { background:var(--red-bg); border:1px solid var(--red-border); color:var(--red); }

        .lbl { font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text3); font-weight:700; margin-bottom:14px; }

        /* GRID */
        .g4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:28px; }
        .g2 { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:28px; }

        /* CARD */
        .c { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:20px; transition:box-shadow .2s; }
        .c:hover { box-shadow:0 2px 8px rgba(0,0,0,.04); }
        .c-lbl { font-size:11px; text-transform:uppercase; letter-spacing:.7px; color:var(--text3); font-weight:600; margin-bottom:6px; }
        .c-val { font-size:28px; font-weight:700; color:var(--text); font-family:var(--mono); letter-spacing:-.5px; line-height:1.2; }
        .c-val.sm { font-size:22px; }
        .c-sub { font-size:11px; color:var(--text3); margin-top:3px; font-family:var(--mono); }
        .c-green { color:var(--green) !important; }
        .c-cyan { color:var(--cyan) !important; }
        .c-yellow { color:var(--yellow) !important; }
        .c-red { color:var(--red) !important; }

        /* RANGE VIS */
        .rv { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:28px; margin-bottom:28px; }
        .rv-hd { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .rv-tt { font-size:15px; font-weight:700; color:var(--text); }
        .rv-tg { font-size:11px; font-family:var(--mono); background:var(--green-bg); color:var(--green); padding:4px 10px; border-radius:6px; border:1px solid var(--green-border); font-weight:600; }
        .rv-bar { position:relative; height:10px; background:var(--surface2); border-radius:5px; margin:28px 0; }
        .rv-z { position:absolute; height:100%; }
        .rv-zl { left:0; width:10%; background:rgba(234,179,8,.1); border-radius:5px 0 0 5px; }
        .rv-zc { left:10%; width:80%; background:rgba(34,197,94,.08); }
        .rv-zr { right:0; width:10%; background:rgba(234,179,8,.1); border-radius:0 5px 5px 0; }
        .rv-cur { position:absolute; top:-7px; width:4px; height:24px; background:var(--green); border-radius:2px; transition:left 1s cubic-bezier(.16,1,.3,1); box-shadow:0 0 8px rgba(34,197,94,.3); }
        .rv-cur span { position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%); font-size:11px; font-family:var(--mono); color:var(--text); white-space:nowrap; font-weight:600; background:var(--surface2); padding:3px 8px; border-radius:4px; }
        .rv-ends { display:flex; justify-content:space-between; font-size:12px; font-family:var(--mono); color:var(--text2); }
        .rv-ends small { display:block; font-size:11px; color:var(--text3); margin-top:2px; }
        .rv-info { display:flex; gap:20px; flex-wrap:wrap; padding:12px 16px; background:var(--surface2); border-radius:10px; margin-top:18px; font-size:12px; font-family:var(--mono); color:var(--text2); }
        .rv-info em { color:var(--green); font-style:normal; font-weight:600; }

        /* PANEL */
        .pan-tt { font-size:14px; font-weight:700; color:var(--text); margin-bottom:14px; }
        .pan-r { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1px solid var(--border); font-size:13px; }
        .pan-r:last-child { border-bottom:none; }
        .pan-r .k { color:var(--text2); }
        .pan-r .v { color:var(--text); font-weight:600; font-family:var(--mono); font-size:12px; }

        /* FORMULA */
        .fm { background:var(--surface2); border-left:3px solid var(--green); border-radius:0 10px 10px 0; padding:18px 22px; margin-top:18px; font-family:var(--mono); font-size:12px; line-height:2; color:var(--text2); }
        .fm strong { color:var(--green); }

        /* TIMELINE */
        .tl { position:relative; padding-left:28px; margin:20px 0; }
        .tl::before { content:''; position:absolute; left:9px; top:0; height:100%; width:2px; background:linear-gradient(180deg,var(--green2),var(--yellow),var(--red),var(--green2)); border-radius:1px; }
        .tl-i { position:relative; margin-bottom:20px; }
        .tl-i::before { content:''; position:absolute; left:-23px; top:5px; width:10px; height:10px; border-radius:50%; }
        .tl-i.g::before { background:var(--green2); }
        .tl-i.y::before { background:var(--yellow); }
        .tl-i.o::before { background:var(--red); opacity:.7; }
        .tl-i.r::before { background:var(--red); }
        .tl-t { font-size:13px; font-weight:600; margin-bottom:2px; }
        .tl-d { font-size:12px; color:var(--text3); }
        .tl-tag { display:inline-block; font-size:10px; font-family:var(--mono); background:var(--surface2); color:var(--text3); padding:2px 7px; border-radius:3px; margin-left:5px; font-weight:600; }

        /* METHOD */
        .meth { font-size:14px; line-height:1.85; color:var(--text2); }
        .meth code { background:rgba(34,197,94,.08); color:var(--green); padding:1px 5px; border-radius:3px; font-family:var(--mono); font-size:12px; }

        /* ACTION PANEL */
        .act { background:var(--surface); border:2px solid var(--green-border); border-radius:16px; padding:28px; margin-bottom:32px; position:relative; overflow:hidden; }
        .act::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg,var(--green),var(--cyan)); }
        .act-title { font-size:16px; font-weight:700; color:var(--text); margin-bottom:6px; }
        .act-sub { font-size:13px; color:var(--text2); margin-bottom:24px; }
        .act-steps { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
        .act-step { background:var(--surface2); border-radius:12px; padding:20px; position:relative; }
        .act-num { display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:50%; background:var(--green); color:#fff; font-size:12px; font-weight:700; margin-bottom:12px; }
        .act-step h4 { font-size:13px; font-weight:700; color:var(--text); margin-bottom:8px; }
        .act-step p { font-size:12px; color:var(--text2); line-height:1.5; margin-bottom:12px; }
        .act-btn { display:inline-flex; align-items:center; gap:6px; padding:10px 18px; border-radius:8px; font-size:13px; font-weight:600; text-decoration:none; cursor:pointer; border:none; transition:all .2s; }
        .act-btn-primary { background:var(--green); color:#fff; }
        .act-btn-primary:hover { background:#16a34a; }
        .act-btn-outline { background:transparent; border:1px solid var(--border2); color:var(--text); }
        .act-btn-outline:hover { border-color:var(--green); color:var(--green); }
        .act-btn-danger { background:var(--red-bg); border:1px solid var(--red-border); color:var(--red); }
        .act-btn-danger:hover { background:#fecaca; }
        .act-vals { display:flex; flex-direction:column; gap:8px; margin-bottom:14px; }
        .act-val-row { display:flex; align-items:center; justify-content:space-between; background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:8px 12px; }
        .act-val-row .label { font-size:11px; color:var(--text3); font-weight:600; }
        .act-val-row .value { font-size:13px; font-family:var(--mono); color:var(--text); font-weight:600; }
        .copy-btn { background:none; border:none; cursor:pointer; font-size:14px; padding:2px 6px; border-radius:4px; transition:background .2s; }
        .copy-btn:hover { background:var(--surface2); }
        .copied { color:var(--green); font-size:11px; font-weight:600; }
        @media(max-width:768px) { .act-steps { grid-template-columns:1fr; } }

        /* FOOTER */
        footer { background:var(--dark); color:#a1a1aa; padding:48px 24px 32px; margin-top:60px; }
        .ft-inner { max-width:1080px; margin:0 auto; }
        .ft-grid { display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:40px; margin-bottom:28px; }
        .ft-brand { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
        .ft-brand img { width:30px; height:30px; border-radius:8px; }
        .ft-desc { font-size:13px; color:#71717a; line-height:1.6; }
        .ft-col h4 { font-size:11px; text-transform:uppercase; letter-spacing:1px; color:#52525b; margin-bottom:10px; font-weight:600; }
        .ft-col a { display:block; font-size:13px; color:#a1a1aa; text-decoration:none; margin-bottom:7px; }
        .ft-col a:hover { color:#fff; }
        .ft-bot { font-size:11px; color:#3f3f46; text-align:center; padding-top:18px; border-top:1px solid rgba(255,255,255,.06); }

        @media(max-width:768px) {
            nav { padding:0 20px; } .nav-links { display:none; }
            .hero h1 { font-size:28px; }
            .g4 { grid-template-columns:repeat(2,1fr); }
            .g2 { grid-template-columns:1fr; }
            .ft-grid { grid-template-columns:1fr 1fr; }
        }
        @media(max-width:480px) { .g4 { grid-template-columns:1fr; } .ft-grid { grid-template-columns:1fr; } }
    </style>
</head>
<body>

<nav>
    <a href="/" class="nav-brand"><img src="./logo_efix_400x400.jpg" alt="EFIX"></a>
    <div class="nav-links">
        <a href="/#how">How It Works</a>
        <a href="/#yield">Yield</a>
        <a href="/#contracts">Contracts</a>
        <a href="/range-monitor" class="active">Range Monitor</a>
        <a href="/#whitepaper">Whitepaper</a>
        <a href="/app" class="nav-cta">Launch App ‚Üí</a>
    </div>
</nav>

<div class="wrap">
    <div class="hero">
        <div class="badge"><span class="dot"></span><span id="live">Connecting...</span></div>
        <h1><em>Range Monitor</em></h1>
        <p>Live Uniswap V3 efixDI/USDC position ¬∑ Polygon Mainnet ¬∑ Auto-refresh 30s</p>
    </div>

    <div class="alert a-ok" id="aBar">
        <span id="aIcon">‚è≥</span>
        <span id="aText">Loading on-chain data...</span>
    </div>

    <div class="lbl">Current Position</div>
    <div class="g4">
        <div class="c"><div class="c-lbl">efixDI Price</div><div class="c-val" id="price">‚Äî</div><div class="c-sub" id="fx">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Range Utilization</div><div class="c-val c-green" id="util">‚Äî</div><div class="c-sub" id="dir">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Est. Days to Exit</div><div class="c-val c-cyan" id="days">‚Äî</div><div class="c-sub">First Passage Time</div></div>
        <div class="c"><div class="c-lbl">Capital Efficiency</div><div class="c-val" id="eff">‚Äî</div><div class="c-sub" id="effS">vs full-range LP</div></div>
    </div>

    <div class="rv">
        <div class="rv-hd">
            <div class="rv-tt">Position in Range</div>
            <div class="rv-tg" id="nftTag">NFT #2847265</div>
        </div>
        <div class="rv-bar">
            <div class="rv-z rv-zl"></div>
            <div class="rv-z rv-zc"></div>
            <div class="rv-z rv-zr"></div>
            <div class="rv-cur" id="cur" style="left:50%"><span id="curL">‚Äî</span></div>
        </div>
        <div class="rv-ends">
            <div><span id="lo">‚Äî</span><small id="loFx">‚Äî</small></div>
            <div style="text-align:center;color:var(--text3);font-size:11px;">‚óÑ BRL weakens ¬∑ Safe Zone ¬∑ BRL strengthens ‚ñ∫</div>
            <div style="text-align:right"><span id="hi">‚Äî</span><small id="hiFx">‚Äî</small></div>
        </div>
        <div class="rv-info">
            <div>Pool: <em>efixDI/USDC</em></div>
            <div>Fee: <em>0.05%</em></div>
            <div>Network: <em>Polygon</em></div>
            <div>Block: <em id="blk">#‚Äî</em></div>
            <div>Updated: <em id="upd">‚Äî</em></div>
        </div>
    </div>

    <div class="lbl">Liquidity Strategy</div>
    <div class="g2">
        <div class="c">
            <div class="pan-tt">‚óà Active Strategy</div>
            <div class="pan-r"><span class="k">Model</span><span class="v">GBM + First Passage</span></div>
            <div class="pan-r"><span class="k">Confidence</span><span class="v">95%</span></div>
            <div class="pan-r"><span class="k">Horizon</span><span class="v">30 days</span></div>
            <div class="pan-r"><span class="k">Annualized Vol</span><span class="v">10.5%</span></div>
            <div class="pan-r"><span class="k">Period Vol</span><span class="v" id="pvol">3.01%</span></div>
            <div class="pan-r"><span class="k">Z-Score</span><span class="v">1.96</span></div>
        </div>
        <div class="c">
            <div class="pan-tt">üîÑ Optimal Range (live)</div>
            <div class="pan-r"><span class="k">Suggested Lower</span><span class="v" id="oL">‚Äî</span></div>
            <div class="pan-r"><span class="k">Suggested Upper</span><span class="v" id="oU">‚Äî</span></div>
            <div class="pan-r"><span class="k">FX Range</span><span class="v" id="oFx">‚Äî</span></div>
            <div class="pan-r"><span class="k">Width</span><span class="v" id="oW">‚Äî</span></div>
            <div class="pan-r"><span class="k">Efficiency (if applied)</span><span class="v" id="oE">‚Äî</span></div>
            <div class="pan-r"><span class="k">Est. next rebalance</span><span class="v" id="oR">‚Äî</span></div>
        </div>
    </div>
    <div class="fm">
        <strong>Range:</strong> P = P_spot √ó exp(¬±z √ó œÉ √ó ‚àö(T/365))&nbsp;&nbsp;|&nbsp;&nbsp;<strong>FPT:</strong> E[œÑ] ‚âà (barrier / œÉ_daily)¬≤&nbsp;&nbsp;|&nbsp;&nbsp;z=1.96, œÉ=10.5%, T=30d
    </div>

    <!-- ACTION PANEL -->
    <div style="margin-top:36px"></div>
    <div class="lbl">‚ö° Optimize Position</div>
    <div class="act">
        <div class="act-title">Concentrate your liquidity for 17√ó more efficiency</div>
        <div class="act-sub">Your position is currently full-range. Follow these 3 steps to apply the GBM-optimized range.</div>
        <div class="act-steps">
            <div class="act-step">
                <div class="act-num">1</div>
                <h4>Remove Liquidity</h4>
                <p>Remove 100% of liquidity from the current full-range position #2847265.</p>
                <a class="act-btn act-btn-danger" href="https://app.uniswap.org/positions/v3/polygon/2847265" target="_blank">
                    Remove on Uniswap ‚Üó
                </a>
            </div>
            <div class="act-step">
                <div class="act-num">2</div>
                <h4>Copy Optimal Range</h4>
                <p>Set these as min/max price when creating the new position:</p>
                <div class="act-vals">
                    <div class="act-val-row">
                        <div>
                            <div class="label">Min Price (Lower)</div>
                            <div class="value" id="copyLo">‚Äî</div>
                        </div>
                        <button class="copy-btn" onclick="copyVal('copyLo')" title="Copy">üìã</button>
                    </div>
                    <div class="act-val-row">
                        <div>
                            <div class="label">Max Price (Upper)</div>
                            <div class="value" id="copyHi">‚Äî</div>
                        </div>
                        <button class="copy-btn" onclick="copyVal('copyHi')" title="Copy">üìã</button>
                    </div>
                </div>
                <div style="font-size:11px;color:var(--text3);">Values update live based on current price</div>
            </div>
            <div class="act-step">
                <div class="act-num">3</div>
                <h4>Create New Position</h4>
                <p>Open Uniswap with efixDI/USDC pre-selected. Paste the range and deposit.</p>
                <a class="act-btn act-btn-primary" id="newPosLink" href="#" target="_blank">
                    New Position on Uniswap ‚Üó
                </a>
                <div style="font-size:11px;color:var(--text3);margin-top:8px;">Fee: 0.05% ¬∑ Gas: ~$0.02</div>
            </div>
        </div>
    </div>

    <div style="margin-top:36px"></div>
    <div class="lbl">Rebalancing Timeline</div>
    <div class="g4">
        <div class="c"><div class="c-lbl">Rebal / Month</div><div class="c-val sm c-cyan" id="rbM">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Rebal / Year</div><div class="c-val sm c-cyan" id="rbY">‚Äî</div></div>
        <div class="c"><div class="c-lbl">Time per Rebal</div><div class="c-val sm">~5min</div></div>
        <div class="c"><div class="c-lbl">Cost (gas)</div><div class="c-val sm">~$0.02</div></div>
    </div>
    <div class="tl">
        <div class="tl-i g"><div class="tl-t" style="color:var(--green)">Position opened <span class="tl-tag">Day 0</span></div><div class="tl-d">Range set, monitor active.</div></div>
        <div class="tl-i y"><div class="tl-t" style="color:var(--yellow)">‚ö† Warning 75% <span class="tl-tag" id="tw">~Day ?</span></div><div class="tl-d">Monitor closely.</div></div>
        <div class="tl-i o"><div class="tl-t" style="color:var(--red);opacity:.7">üî∂ Critical 90% <span class="tl-tag" id="tc">~Day ?</span></div><div class="tl-d">Prepare new position.</div></div>
        <div class="tl-i r"><div class="tl-t" style="color:var(--red)">üö® Out of Range <span class="tl-tag" id="te">~Day ?</span></div><div class="tl-d">Rebalance NOW.</div></div>
        <div class="tl-i g"><div class="tl-t" style="color:var(--green)">‚úÖ Reset <span class="tl-tag">New cycle</span></div><div class="tl-d">Recalculated range applied.</div></div>
    </div>

    <div style="margin-top:36px"></div>
    <div class="lbl">Methodology</div>
    <div class="meth">
        <p>Range calculated via <code>Geometric Brownian Motion</code> (Black-Scholes framework), projecting
        price bounds at 95% confidence over 30 days using BRL/USD implied volatility (œÉ ‚âà 10.5% ann.).
        Rebalancing frequency via <code>First Passage Time</code>. All data read on-chain from Polygon
        via <code>slot0()</code> ‚Äî zero backend, zero API keys.</p>
    </div>
</div>

<footer>
    <div class="ft-inner">
        <div class="ft-grid">
            <div><div class="ft-brand"><img src="./logo_efix_400x400.jpg" alt="EFIX"><span style="color:#fff;font-weight:600;">EFIX Protocol</span></div><div class="ft-desc">Bridging Brazilian fixed-income into DeFi. CVM-regulated.</div></div>
            <div class="ft-col"><h4>Protocol</h4><a href="https://app.morpho.org/base/vault/0xf4A3FaDcEf350B2F168F97Cdbaa2221FF29ACBd5" target="_blank">Morpho Vault</a><a href="https://polygonscan.com/address/0x04082b283818D9d0dd9Ee8742892eEe5CC396441" target="_blank">Token (Polygon)</a><a href="https://app.uniswap.org/positions/v3/polygon/2847265" target="_blank">Uniswap Position</a></div>
            <div class="ft-col"><h4>Resources</h4><a href="./efixDI_Whitepaper_v1.pdf">Whitepaper</a><a href="https://github.com/Ernesto711/efix-pr-repo" target="_blank">GitHub</a></div>
            <div class="ft-col"><h4>Contact</h4><a href="mailto:contato@efix.com.br">contato@efix.com.br</a><a>Rio de Janeiro, Brazil</a></div>
        </div>
        <div class="ft-bot">¬© 2026 Efix Securitizadora S.A. ¬∑ CNPJ 60.756.859/0001-57 ¬∑ CVM Act 23.635/2025</div>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
<script>
(function(){
    const C = {
        pid:2847265,
        nft:'0xC36442b4a4522E871399CD717aBDD847Ab11FE88',
        fac:'0x1F98431c8aD98523631AE4a59f267346ea31F984',
        rpcs:['https://polygon-bor-rpc.publicnode.com','https://polygon.drpc.org','https://1rpc.io/matic','https://polygon.meowrpc.com'],
        ms:30000, z:1.96, vol:0.105, days:30,
    };

    // MINIMAL ABIs ‚Äî using tuples to avoid named-param issues
    const NABI=['function positions(uint256 tokenId) external view returns (uint96, address, address, address, uint24, int24, int24, uint128, uint256, uint256, uint128, uint128)'];
    const FABI=['function getPool(address, address, uint24) external view returns (address)'];
    // CRITICAL: slot0 returns sqrtPriceX96 (uint160) FIRST, tick (int24) SECOND
    const PABI=['function slot0() external view returns (uint160, int24, uint16, uint16, uint16, uint8, bool)','function liquidity() external view returns (uint128)'];

    function s2p(sqrtPX96) {
        // sqrtPriceX96 is token1/token0 in Q96 format
        // For efixDI(18 dec)/USDC(6 dec): price = (sqrtP/2^96)^2 * 10^12
        const s = Number(sqrtPX96) / (2**96);
        return s * s * 1e12;
    }
    function t2p(tick) {
        // Safe for extreme ticks
        return Math.exp(tick * Math.log(1.0001)) * 1e12;
    }
    function gbm(p,v,d,z) {
        const pv=v*Math.sqrt(d/365), lo=p*Math.exp(-z*pv), hi=p*Math.exp(z*pv);
        return {lo, hi, pv, eff:Math.sqrt(p)/(Math.sqrt(hi)-Math.sqrt(lo))};
    }
    function fpt(v,b) { return Math.pow(Math.max(b,0.0001)/(v/Math.sqrt(365)), 2); }
    function isFullRange(tL,tU) { return tL < -800000 && tU > 800000; }

    async function gp() {
        for (const u of C.rpcs) try { const p=new ethers.JsonRpcProvider(u); await p.getBlockNumber(); return p; } catch{continue;}
        throw new Error('RPCs failed');
    }
    const $=id=>document.getElementById(id);

    async function fetchData() {
        const pv=await gp(), bn=await pv.getBlockNumber();
        const nft=new ethers.Contract(C.nft,NABI,pv), pos=await nft.positions(C.pid);

        // Index-based access (bulletproof)
        const token0=pos[2], token1=pos[3], fee=Number(pos[4]);
        const tL=Number(pos[5]), tU=Number(pos[6]);

        const fac=new ethers.Contract(C.fac,FABI,pv), pa=await fac.getPool(token0,token1,fee);
        const pool=new ethers.Contract(pa,PABI,pv);
        const [s0,pl]=await Promise.all([pool.slot0(),pool.liquidity()]);

        // s0[0] = sqrtPriceX96 (uint160), s0[1] = tick (int24)
        const sqrtPX96 = s0[0];
        const tick = Number(s0[1]);

        console.log('[Range Monitor] sqrtPriceX96:', sqrtPX96.toString());
        console.log('[Range Monitor] tick:', tick, '| tickLower:', tL, '| tickUpper:', tU);
        console.log('[Range Monitor] inRange:', tick >= tL && tick <= tU);
        console.log('[Range Monitor] isFullRange:', isFullRange(tL, tU));

        const cp = s2p(sqrtPX96);
        console.log('[Range Monitor] price:', cp);

        return { cp, tL, tU, tick, ir: tick >= tL && tick <= tU, bn, full: isFullRange(tL, tU) };
    }

    function ui(d) {
        const full = d.full;
        const o = gbm(d.cp, C.vol, C.days, C.z);
        const optHalf = o.hi/d.cp - 1;
        const optFpt = fpt(C.vol, optHalf);

        // Price
        $('price').textContent = '$'+d.cp.toFixed(5);
        $('fx').textContent = '‚âà R$'+(1/d.cp).toFixed(2)+'/USD';

        // Utilization
        const ue=$('util');
        if (full) {
            ue.textContent = 'Full Range';
            ue.className = 'c-val sm c-cyan';
            $('dir').textContent = 'Concentrate for '+o.eff.toFixed(0)+'x efficiency';
        } else {
            // Log-scale utilization for concentrated positions
            const pL = t2p(d.tL), pU = t2p(d.tU);
            const logU = Math.abs(Math.log(d.cp/pL) - Math.log(pU/pL)*0.5) / (Math.log(pU/pL)*0.5);
            const u = Math.min(logU, 1);
            ue.textContent = (u*100).toFixed(1)+'%';
            ue.className = 'c-val '+(u>.9?'c-red':u>.75?'c-yellow':'c-green');
            $('dir').textContent = d.tick > (d.tL+d.tU)/2 ? '‚Üí Upper' : '‚Üê Lower';
        }

        // Days / Efficiency
        const de=$('days'), ee=$('eff');
        if (full) {
            de.textContent = '‚àû'; de.className='c-val sm c-green';
            ee.textContent = '1.0x'; $('effS').textContent = 'Full range = no concentration';
        } else {
            const pL=t2p(d.tL), pU=t2p(d.tU);
            const halfW = Math.abs(Math.log(pU/d.cp));
            const dte = fpt(C.vol, Math.exp(halfW)-1);
            de.textContent = '~'+Math.round(dte)+'d';
            de.className = 'c-val sm '+(dte<7?'c-red':dte<21?'c-yellow':'c-cyan');
            const eff = Math.sqrt(d.cp)/(Math.sqrt(pU)-Math.sqrt(pL));
            ee.textContent = eff.toFixed(1)+'x';
        }

        $('rbM').textContent = full ? '0' : (30/optFpt<1?'<1':'~'+(30/optFpt).toFixed(1));
        $('rbY').textContent = full ? '0' : '~'+Math.round(365/optFpt);

        // Range bar
        $('cur').style.left = '50%'; // Center for full-range
        $('curL').textContent = '$'+d.cp.toFixed(5);
        if (full) {
            $('lo').textContent = 'MIN (full range)';
            $('loFx').textContent = 'tick '+d.tL;
            $('hi').textContent = 'MAX (full range)';
            $('hiFx').textContent = 'tick +'+d.tU;
            $('nftTag').textContent = 'NFT #2847265 ¬∑ FULL RANGE';
        } else {
            const pL=t2p(d.tL), pU=t2p(d.tU);
            const logP = (Math.log(d.cp)-Math.log(pL))/(Math.log(pU)-Math.log(pL));
            $('cur').style.left = Math.max(2,Math.min(98,logP*100))+'%';
            $('lo').textContent = '$'+pL.toFixed(5);
            $('loFx').textContent = '‚âà R$'+(1/pL).toFixed(2)+'/USD';
            $('hi').textContent = '$'+pU.toFixed(5);
            $('hiFx').textContent = '‚âà R$'+(1/pU).toFixed(2)+'/USD';
        }

        $('blk').textContent = '#'+d.bn.toLocaleString();
        $('upd').textContent = new Date().toLocaleTimeString('pt-BR');
        $('live').textContent = d.ir ? 'In Range ¬∑ Live on Polygon' : 'Out of Range';

        // Alert
        const ab=$('aBar'),at=$('aText'),ai=$('aIcon');
        if (!d.ir) {
            ab.className='alert a-crit'; ai.textContent='üö®';
            at.innerHTML='<strong>OUT OF RANGE</strong> ‚Äî Rebalancing needed.';
        } else if (full) {
            ab.className='alert a-ok'; ai.textContent='üì°';
            at.innerHTML='Position is <strong>full-range</strong> (always in range). Apply concentrated range below for <strong>'+o.eff.toFixed(0)+'x</strong> capital efficiency.';
        } else {
            const pL=t2p(d.tL), pU=t2p(d.tU);
            const u = Math.abs(Math.log(d.cp/pL)-Math.log(pU/pL)*0.5)/(Math.log(pU/pL)*0.5);
            if (u>=.9) { ab.className='alert a-crit'; ai.textContent='üî∂'; at.innerHTML='<strong>CRITICAL</strong> ‚Äî '+(u*100).toFixed(0)+'% used.'; }
            else if (u>=.75) { ab.className='alert a-warn'; ai.textContent='‚ö†'; at.innerHTML='<strong>WARNING</strong> ‚Äî '+(u*100).toFixed(0)+'% consumed.'; }
            else { ab.className='alert a-ok'; ai.textContent='‚úÖ'; at.innerHTML='Healthy ‚Äî '+(u*100).toFixed(0)+'% used.'; }
        }

        // Optimal
        $('oL').textContent = '$'+o.lo.toFixed(5);
        $('oU').textContent = '$'+o.hi.toFixed(5);
        $('oFx').textContent = 'R$'+(1/o.hi).toFixed(2)+'‚Äì'+(1/o.lo).toFixed(2);
        $('oW').textContent = '¬±'+(optHalf*100).toFixed(1)+'%';
        $('oE').textContent = o.eff.toFixed(1)+'x';
        $('pvol').textContent = (o.pv*100).toFixed(2)+'%';
        $('oR').textContent = '~'+Math.round(optFpt)+'d';
        $('tw').textContent = '~Day '+Math.round(fpt(C.vol, optHalf*.75));
        $('tc').textContent = '~Day '+Math.round(fpt(C.vol, optHalf*.90));
        $('te').textContent = '~Day '+Math.round(optFpt);

        // Action panel ‚Äî copy values & Uniswap deep link
        $('copyLo').textContent = o.lo.toFixed(5);
        $('copyHi').textContent = o.hi.toFixed(5);

        // Uniswap V3 "New Position" deep link
        // efixDI on Polygon: 0x04082b283818D9d0dd9Ee8742892eEe5CC396441
        // USDC on Polygon: 0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359
        const efixDI = '0x04082b283818D9d0dd9Ee8742892eEe5CC396441';
        const usdc = '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359';
        const uniLink = 'https://app.uniswap.org/add/'+efixDI+'/'+usdc+'/500?chain=polygon&minPrice='+o.lo.toFixed(8)+'&maxPrice='+o.hi.toFixed(8);
        $('newPosLink').href = uniLink;

        // Update action panel subtitle with live efficiency
        const actSub = document.querySelector('.act-sub');
        if (actSub) {
            if (full) {
                actSub.textContent = 'Your position is full-range (1x efficiency). Concentrating to the optimal range gives you '+o.eff.toFixed(0)+'x capital efficiency.';
            } else {
                actSub.textContent = 'Position is concentrated. Use these values to rebalance when needed.';
            }
        }
    }

    async function go() {
        try { ui(await fetchData()); }
        catch(e) { console.error('[Range Monitor] Error:', e); $('live').textContent='RPC Error ‚Äî retrying...'; }
    }
    go(); setInterval(go, C.ms);
})();

// Copy to clipboard helper (outside IIFE for onclick access)
function copyVal(id) {
    const el = document.getElementById(id);
    const val = el.textContent;
    navigator.clipboard.writeText(val).then(() => {
        const btn = el.parentElement.nextElementSibling || el.closest('.act-val-row').querySelector('.copy-btn');
        const orig = btn.textContent;
        btn.innerHTML = '<span class="copied">‚úì Copied</span>';
        setTimeout(() => { btn.textContent = orig || 'üìã'; }, 1500);
    }).catch(() => {
        // Fallback for older browsers
        const ta = document.createElement('textarea');
        ta.value = val; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
    });
}
</script>
</body>
</html>
