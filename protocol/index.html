<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>efixDI+ Protocol Dashboard</title>
    <link rel="icon" type="image/jpeg" href="../apppp/logo_efix_400x400.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #000000;
            --white: #ffffff;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
            --green: #22c55e;
            --green-bg: #f0fdf4;
            --red: #ef4444;
            --red-bg: #fef2f2;
            --yellow: #f59e0b;
            --yellow-bg: #fffbeb;
            --blue: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Syne', -apple-system, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.7;
            min-height: 100vh;
        }

        ::selection { background: var(--black); color: var(--white); }

        /* Nav */
        nav {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-200);
            z-index: 1000; padding: 1rem 2rem;
        }

        .nav-content {
            max-width: 1400px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
        }

        .nav-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--black); }
        .nav-logo img { height: 32px; width: auto; }
        .nav-logo span { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.02em; }

        .nav-right { display: flex; align-items: center; gap: 2rem; }

        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-links a {
            color: var(--gray-600); text-decoration: none; font-size: 0.875rem;
            font-weight: 500; letter-spacing: 0.02em; transition: color 0.2s;
        }
        .nav-links a:hover, .nav-links a.active { color: var(--black); }

        .nav-badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--gray-100); padding: 6px 14px;
            border-radius: 50px; font-size: 0.75rem; color: var(--gray-600); font-weight: 600;
        }
        .nav-dot { width: 7px; height: 7px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

        /* Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }

        /* Page Header */
        .page-header { padding: 7rem 0 2rem; text-align: center; }
        .page-header h1 { font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.5rem; }
        .page-header p { color: var(--gray-500); font-size: 1.1rem; }

        /* KPI Row */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        @media (max-width: 900px) { .kpi-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 600px) { .kpi-grid { grid-template-columns: 1fr; } }

        .kpi {
            background: var(--white); border: 1px solid var(--gray-200);
            border-radius: 16px; padding: 1.5rem; transition: all 0.3s;
        }
        .kpi:hover { border-color: var(--black); box-shadow: 0 8px 30px rgba(0,0,0,0.06); }
        .kpi-label {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--gray-500); margin-bottom: 8px; font-weight: 600;
        }
        .kpi-value { font-family: 'Space Mono', monospace; font-size: 1.7rem; font-weight: 700; }
        .kpi-sub { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; }

        /* Tabs */
        .tabs {
            display: flex; background: var(--gray-100); border-radius: 10px;
            padding: 4px; margin-bottom: 2rem;
        }
        .tab {
            flex: 1; padding: 0.75rem; text-align: center; border-radius: 8px;
            font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;
            border: none; background: transparent; font-family: inherit; color: var(--gray-500);
        }
        .tab.active { background: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--black); }

        /* Cards */
        .card {
            background: var(--white); border: 1px solid var(--gray-200);
            border-radius: 16px; padding: 2rem; transition: all 0.3s; margin-bottom: 1.5rem;
        }
        .card:hover { border-color: var(--black); box-shadow: 0 8px 30px rgba(0,0,0,0.06); }
        .card-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px; }
        .card-meta { font-size: 0.78rem; color: var(--gray-500); margin-bottom: 1rem; }

        /* Table */
        .tbl { width: 100%; border-collapse: collapse; }
        .tbl th {
            text-align: left; padding: 12px 16px; background: var(--gray-100);
            font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--gray-500); font-weight: 600; border-bottom: 1px solid var(--gray-200);
        }
        .tbl th:first-child { border-radius: 8px 0 0 0; }
        .tbl th:last-child { border-radius: 0 8px 0 0; }
        .tbl td { padding: 12px 16px; border-bottom: 1px solid var(--gray-100); font-size: 0.88rem; }
        .tbl tr:hover td { background: var(--gray-100); }
        .tbl tr.highlight td { background: #f0fdf4; }
        .tbl .mono { font-family: 'Space Mono', monospace; }

        /* Badge */
        .badge-sm {
            display: inline-block; padding: 2px 10px; border-radius: 50px;
            font-size: 0.65rem; font-weight: 700; letter-spacing: 0.03em;
        }
        .badge-green { background: var(--green-bg); color: var(--green); }
        .badge-yellow { background: var(--yellow-bg); color: var(--yellow); }
        .badge-red { background: var(--red-bg); color: var(--red); }

        /* Bar Chart */
        .bar-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .bar-label { width: 140px; font-size: 0.8rem; color: var(--gray-600); flex-shrink: 0; }
        .bar-track { flex: 1; background: var(--gray-100); border-radius: 8px; height: 32px; overflow: hidden; }
        .bar-fill {
            height: 100%; border-radius: 8px; display: flex; align-items: center;
            justify-content: flex-end; padding-right: 12px;
            transition: width 1s cubic-bezier(.23,1,.32,1);
        }
        .bar-fill-text { font-family: 'Space Mono', monospace; font-size: 0.72rem; font-weight: 700; color: var(--white); }
        .bar-end { width: 100px; text-align: right; font-size: 0.75rem; color: var(--gray-500); font-family: 'Space Mono', monospace; }

        /* Stress Chips */
        .stress-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .stress-chip {
            padding: 8px 16px; background: var(--gray-100); border: 2px solid transparent;
            border-radius: 8px; font-size: 0.82rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; font-family: inherit; color: var(--gray-600);
        }
        .stress-chip:hover { border-color: var(--gray-300); }
        .stress-chip.active { background: var(--black); color: var(--white); border-color: var(--black); }

        /* Matrix */
        .matrix { width: 100%; border-collapse: separate; border-spacing: 4px; }
        .matrix th { padding: 8px; font-size: 0.7rem; color: var(--gray-500); font-weight: 600; text-align: center; }
        .matrix td {
            padding: 8px 6px; text-align: center; border-radius: 8px;
            font-family: 'Space Mono', monospace; font-size: 0.78rem; font-weight: 700;
        }
        .matrix .th-left { text-align: left; }

        /* Info Box */
        .info-box {
            padding: 1rem 1.25rem; border-radius: 12px; margin-top: 1.5rem;
        }
        .info-box.green { background: var(--green-bg); border: 1px solid #bbf7d0; }
        .info-box .info-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 4px; }
        .info-box .info-text { font-size: 0.78rem; color: var(--gray-600); line-height: 1.5; }

        /* Protocol List */
        .proto-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: var(--gray-100); border-radius: 12px; margin-bottom: 8px;
            transition: all 0.2s;
        }
        .proto-item:hover { background: var(--gray-200); }
        .proto-name { font-weight: 600; font-size: 0.88rem; }
        .proto-addr { font-family: 'Space Mono', monospace; font-size: 0.75rem; color: var(--gray-500); }
        .proto-desc { font-size: 0.72rem; color: var(--gray-400); }

        /* Grid helpers */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        /* Backend services grid */
        .svc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        @media (max-width: 700px) { .svc-grid { grid-template-columns: 1fr; } }
        .svc-item { background: var(--gray-100); border-radius: 12px; padding: 14px; }
        .svc-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; }
        .svc-desc { font-size: 0.72rem; color: var(--gray-500); }

        /* Terminal */
        .terminal {
            background: var(--gray-900); border-radius: 12px; padding: 1.25rem;
            font-family: 'Space Mono', monospace; font-size: 0.72rem; line-height: 1.8;
            max-height: 380px; overflow-y: auto; color: #a3a3a3;
        }
        .t-green { color: #4ade80; }
        .t-yellow { color: #facc15; }
        .t-red { color: #f87171; }
        .t-white { color: #f5f5f5; }
        .t-dim { color: #737373; }

        .btn-term {
            padding: 8px 18px; border-radius: 8px; font-weight: 600; font-size: 0.82rem;
            cursor: pointer; transition: all 0.2s; font-family: inherit; border: none;
        }
        .btn-black { background: var(--black); color: var(--white); }
        .btn-black:hover { background: var(--gray-800); transform: translateY(-1px); }
        .btn-outline { background: var(--white); color: var(--gray-600); border: 2px solid var(--gray-300); }
        .btn-outline:hover { border-color: var(--black); color: var(--black); }

        /* Footer */
        footer {
            background: var(--black); color: var(--white);
            padding: 2rem; margin-top: 4rem; text-align: center;
            font-size: 0.82rem; color: var(--gray-400);
        }
        footer a { color: var(--gray-300); text-decoration: none; }
        footer a:hover { color: var(--white); }

        /* Tab panels */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
    </style>
</head>
<body>

<!-- Nav -->
<nav>
    <div class="nav-content">
        <a href="../apppp/" class="nav-logo">
            <img src="../apppp/logo_efix_400x400.jpg" alt="Efix">
            <span>efixDI+</span>
        </a>
        <div class="nav-right">
            <ul class="nav-links">
                <li><a href="../apppp/">App</a></li>
                <li><a href="./" class="active">Protocol</a></li>
                <li><a href="https://polygonscan.com/address/0x2eA512b4C5e53A8c1302AC8ba2d43c5DA90b307C" target="_blank">Contratos</a></li>
            </ul>
            <div class="nav-badge">
                <span class="nav-dot"></span>
                <span id="navStatus">Mainnet</span>
            </div>
        </div>
    </div>
</nav>

<!-- Page Header -->
<div class="container">
    <div class="page-header">
        <h1>Protocol Dashboard</h1>
        <p>Real-time metrics, APY projections & stress testing</p>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="kpi">
            <div class="kpi-label">Protocol TVL</div>
            <div class="kpi-value" id="kpi-tvl">R$ ‚Äî</div>
            <div class="kpi-sub" id="kpi-tvl-usd">Loading...</div>
        </div>
        <div class="kpi">
            <div class="kpi-label">efixDI Supply</div>
            <div class="kpi-value" id="kpi-supply">‚Äî</div>
            <div class="kpi-sub">Polygon + Base</div>
        </div>
        <div class="kpi">
            <div class="kpi-label">BRL/USD Rate</div>
            <div class="kpi-value" id="kpi-rate">‚Äî</div>
            <div class="kpi-sub">Chainlink Oracle</div>
        </div>
        <div class="kpi">
            <div class="kpi-label">Backend Uptime</div>
            <div class="kpi-value" id="kpi-uptime">‚Äî</div>
            <div class="kpi-sub">Railway 24/7</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('apy',this)">üìä APY Projections</button>
        <button class="tab" onclick="switchTab('stress',this)">‚ö° Stress Tests</button>
        <button class="tab" onclick="switchTab('terminal',this)">üñ•Ô∏è Live Queries</button>
        <button class="tab" onclick="switchTab('arch',this)">üèóÔ∏è Architecture</button>
    </div>

    <!-- APY Panel -->
    <div class="tab-panel active" id="panel-apy">
        <div class="card">
            <div class="card-title">üìä APY by Leverage Scenario</div>
            <div class="card-meta">
                CDI/SELIC: <strong>14.90%</strong> ¬∑ Morpho Borrow: <strong>0.67%</strong> ¬∑ Performance Fee: <strong>20%</strong> ¬∑ LLTV: <strong>77%</strong>
            </div>
            <table class="tbl">
                <thead><tr><th></th><th>Scenario</th><th>LTV</th><th>Leverage</th><th>Net APY</th><th>On R$100K/yr</th><th>Health Factor</th><th>Risk</th></tr></thead>
                <tbody id="apyBody"></tbody>
            </table>
        </div>
        <div class="card">
            <div class="card-title">Visual Comparison</div>
            <div id="apyBars"></div>
        </div>
    </div>

    <!-- Stress Panel -->
    <div class="tab-panel" id="panel-stress">
        <div class="stress-chips" id="stressChips"></div>
        <div class="card" id="stressTable"></div>
        <div class="card" id="stressMatrix">
            <div class="card-title">Health Factor Matrix (LTV √ó BRL Shock)</div>
            <table class="matrix" id="matrixTable"></table>
        </div>
    </div>

    <!-- Terminal Panel -->
    <div class="tab-panel" id="panel-terminal">
        <div class="card">
            <div style="display:flex;gap:8px;margin-bottom:1rem;flex-wrap:wrap">
                <button class="btn-term btn-black" onclick="runCmd('health')">Health Check</button>
                <button class="btn-term btn-black" onclick="runCmd('status')">Dashboard Status</button>
                <button class="btn-term btn-black" onclick="runCmd('morpho')">Morpho Position</button>
                <button class="btn-term btn-black" onclick="runCmd('all')">‚ñ∂ Run All</button>
                <button class="btn-term btn-outline" onclick="document.getElementById('termOut').innerHTML=''">Clear</button>
            </div>
            <div class="terminal" id="termOut">
                <div><span class="t-green">$</span> <span class="t-dim">Ready ‚Äî click a button to query the live protocol.</span></div>
            </div>
        </div>
    </div>

    <!-- Architecture Panel -->
    <div class="tab-panel" id="panel-arch">
        <div class="grid-2">
            <div class="card">
                <div class="card-title">Polygon Mainnet <span class="badge-sm badge-green">Chain 137</span></div>
                <div id="archPoly"></div>
            </div>
            <div class="card">
                <div class="card-title">Base Mainnet <span class="badge-sm badge-green">Chain 8453</span></div>
                <div id="archBase"></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Backend v3.0 ‚Äî Railway 24/7</div>
            <div class="svc-grid" id="archSvc"></div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <p>efixDI+ Protocol ‚Äî <a href="https://github.com/Develop-ltda" target="_blank">GitHub</a> ¬∑ <a href="https://polygonscan.com/address/0x2eA512b4C5e53A8c1302AC8ba2d43c5DA90b307C" target="_blank">VaultV2</a> ¬∑ <a href="https://app.morpho.org/base/vault/0xf4A3FaDcEf350B2F168F97Cdbaa2221FF29ACBd5" target="_blank">Morpho Vault</a></p>
    <p style="margin-top:8px;font-size:.72rem">EFIX Securitizadora ‚Äî CVM Resolution 88/2022</p>
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BE='https://efixdi-backend-production.up.railway.app';
const AK='efixdi-admin-2026';
const SELIC=14.90,MBR=0.67,PF=0.20,LLTV=0.77;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcAPY(ltv,cdi){cdi=cdi||SELIC;if(!ltv)return cdi*(1-PF);const l=1/(1-ltv);return(cdi*l-MBR*(l-1))*(1-PF)}
function calcHF(ltv,shock){shock=shock||0;if(!ltv)return Infinity;return(LLTV*(1+shock/100))/ltv}
function riskInfo(hf){
  if(hf===Infinity||hf>=1.5)return{t:'SAFE',c:'badge-green'};
  if(hf>=1.15)return{t:'WARNING',c:'badge-yellow'};
  if(hf>=1.0)return{t:'AUTO-DELEV',c:'badge-yellow'};
  return{t:'LIQUIDATION',c:'badge-red'};
}
function fmt(n){return n.toLocaleString('pt-BR',{maximumFractionDigits:0})}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchLive(){
  try{
    const[h,s]=await Promise.all([
      fetch(BE+'/health').then(r=>r.json()),
      fetch(BE+'/api/status?key='+AK).then(r=>r.json())
    ]);
    const p=s.protocol;
    document.getElementById('kpi-tvl').textContent='R$ '+parseFloat(p.tvl_brl).toFixed(2);
    document.getElementById('kpi-tvl-usd').textContent='$'+parseFloat(p.tvl_usd).toFixed(2)+' USD';
    document.getElementById('kpi-supply').textContent=parseFloat(p.efix_total_supply).toFixed(2);
    document.getElementById('kpi-rate').textContent=parseFloat(p.brl_usd_rate).toFixed(6);
    document.getElementById('kpi-uptime').textContent=Math.floor(h.uptime/3600)+'h '+Math.floor((h.uptime%3600)/60)+'m';
    document.getElementById('navStatus').textContent='Mainnet ¬∑ Block '+h.block;
  }catch(e){
    document.getElementById('kpi-tvl').textContent='R$ 100.09';
    document.getElementById('kpi-tvl-usd').textContent='$19.18 USD';
    document.getElementById('kpi-supply').textContent='678.77';
    document.getElementById('kpi-rate').textContent='0.191626';
    document.getElementById('kpi-uptime').textContent='‚Äî';
  }
}
fetchLive();setInterval(fetchLive,30000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(id,btn){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APY TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const scenarios=[
  {n:'Hold (no leverage)',ltv:0,e:'üè¶'},
  {n:'Conservative',ltv:.30,e:'üü¢'},
  {n:'Moderate',ltv:.50,e:'üü°'},
  {n:'‚òÖ Target Range',ltv:.60,e:'‚≠ê',hl:1},
  {n:'Aggressive',ltv:.70,e:'üü†'},
  {n:'Max Leverage',ltv:.75,e:'üî¥'},
];

const maxAPY=calcAPY(.75);
let apyHTML='',barHTML='';
scenarios.forEach((s,i)=>{
  const apy=calcAPY(s.ltv),hf=calcHF(s.ltv),ri=riskInfo(hf);
  const annual=100000*apy/100,lev=s.ltv?((1/(1-s.ltv)).toFixed(1)+'x'):'‚Äî';
  const pct=(apy/maxAPY*100).toFixed(1);
  apyHTML+=`<tr class="${s.hl?'highlight':''}">
    <td>${s.e}</td><td style="font-weight:${s.hl?700:400}">${s.n}</td>
    <td class="mono">${(s.ltv*100).toFixed(0)}%</td><td class="mono">${lev}</td>
    <td class="mono" style="font-weight:700;font-size:1rem">${apy.toFixed(1)}%</td>
    <td class="mono">R$ ${fmt(annual)}</td>
    <td class="mono">${hf===Infinity?'‚àû':hf.toFixed(2)}</td>
    <td><span class="badge-sm ${ri.c}">${ri.t}</span></td></tr>`;

  barHTML+=`<div class="bar-row">
    <div class="bar-label">${s.e} ${s.n.replace('‚òÖ ','')}</div>
    <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${s.hl?'var(--black)':'var(--gray-700)'}">
      <span class="bar-fill-text">${apy.toFixed(1)}%</span></div></div>
    <div class="bar-end">R$${fmt(annual)}</div></div>`;
});
document.getElementById('apyBody').innerHTML=apyHTML;
document.getElementById('apyBars').innerHTML=barHTML;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STRESS TESTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const stressTests=[
  {n:'Normal',s:0,cdi:14.90,e:'‚úÖ'},
  {n:'BRL ‚àí10%',s:-10,cdi:15.50,e:'‚ö†Ô∏è'},
  {n:'BRL ‚àí20%',s:-20,cdi:16.50,e:'üî∂'},
  {n:'BRL ‚àí30%',s:-30,cdi:18.00,e:'üî¥'},
  {n:'BRL ‚àí40% Black Swan',s:-40,cdi:20.00,e:'üíÄ'},
  {n:'BRL +15% Rally',s:15,cdi:13.50,e:'üöÄ'},
];

let activeStress=0;
const chipsEl=document.getElementById('stressChips');
stressTests.forEach((st,i)=>{
  const btn=document.createElement('button');
  btn.className='stress-chip'+(i===0?' active':'');
  btn.textContent=st.e+' '+st.n;
  btn.onclick=()=>{activeStress=i;
    document.querySelectorAll('.stress-chip').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');renderStress()};
  chipsEl.appendChild(btn);
});

function renderStress(){
  const st=stressTests[activeStress];
  let html=`<div class="card-title">${st.e} ${st.n}</div>
    <div class="card-meta">BRL/USD: <strong>${st.s>=0?'+':''}${st.s}%</strong> ¬∑ CDI: <strong>${st.cdi}%</strong></div>
    <table class="tbl"><thead><tr><th>LTV</th><th>Net APY</th><th>Health Factor</th><th>Annual R$100K</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
  [0,.30,.50,.60,.70,.75].forEach((ltv,i)=>{
    const lev=ltv?1/(1-ltv):1;
    const apy=(st.cdi*lev-MBR*(lev-1))*(1-PF);
    const hf=calcHF(ltv,st.s),ri=riskInfo(hf);
    const action=hf===Infinity||hf>=1.5?'None':hf>=1.15?'Monitor':hf>=1.0?'AUTO-DELEVERAGE':'EMERGENCY UNWIND';
    html+=`<tr><td class="mono">${(ltv*100).toFixed(0)}%</td>
      <td class="mono" style="font-weight:700">${apy.toFixed(1)}%</td>
      <td class="mono">${hf===Infinity?'‚àû':hf.toFixed(2)}</td>
      <td class="mono">R$ ${fmt(100000*apy/100)}</td>
      <td><span class="badge-sm ${ri.c}">${ri.t}</span></td>
      <td style="font-weight:${action!=='None'?700:400};color:${action.includes('EMERGENCY')?'var(--red)':action.includes('AUTO')?'var(--yellow)':'var(--gray-400)'}">${action}</td></tr>`;
  });
  html+='</tbody></table>';
  if(st.s<=-20)html+=`<div class="info-box green"><div class="info-title">üõ°Ô∏è D+0 Redemption Protection</div>
    <div class="info-text">Underlying DI fund shares redeem instantly (D+0). BRL capital is 100% preserved regardless of USD exchange rate. Auto-deleverage triggers at HF < 1.15, reducing exposure before liquidation.</div></div>`;
  document.getElementById('stressTable').innerHTML=html;
}
renderStress();

// Matrix
let mx='<thead><tr><th class="th-left"></th>';
[-40,-30,-20,-10,0,10,15].forEach(s=>{mx+=`<th style="color:${s<0?'var(--red)':'var(--green)'}">${s>=0?'+':''}${s}%</th>`});
mx+='</tr></thead><tbody>';
[.30,.50,.60,.70,.75].forEach(ltv=>{
  mx+=`<tr><td class="th-left" style="font-weight:700">${(ltv*100)}% LTV</td>`;
  [-40,-30,-20,-10,0,10,15].forEach(s=>{
    const hf=calcHF(ltv,s),ri=riskInfo(hf);
    const bgMap={'badge-green':'var(--green-bg)','badge-yellow':'var(--yellow-bg)','badge-red':'var(--red-bg)'};
    const cMap={'badge-green':'var(--green)','badge-yellow':'var(--yellow)','badge-red':'var(--red)'};
    mx+=`<td style="background:${bgMap[ri.c]};color:${cMap[ri.c]}">${hf.toFixed(2)}</td>`;
  });
  mx+='</tr>';
});
mx+='</tbody>';
document.getElementById('matrixTable').innerHTML=mx;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TERMINAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const termEl=document.getElementById('termOut');
function tLine(cls,txt){termEl.innerHTML+=`<div><span class="${cls}">${txt}</span></div>`;termEl.scrollTop=termEl.scrollHeight}

async function runCmd(cmd){
  if(cmd==='all'){await runCmd('health');await new Promise(r=>setTimeout(r,300));await runCmd('status');await new Promise(r=>setTimeout(r,300));await runCmd('morpho');return}
  tLine('t-green','$ curl '+BE+'/'+(cmd==='health'?'health':cmd==='status'?'api/status':cmd));
  try{
    if(cmd==='health'){
      const r=await fetch(BE+'/health').then(r=>r.json());
      tLine('t-green','HTTP 200 ‚Äî '+r.ts);
      tLine('t-white','  status: '+r.status+' | block: '+r.block+' | uptime: '+Math.floor(r.uptime/3600)+'h');
      Object.entries(r.services).forEach(([k,v])=>{
        const ok=v.match(/connected|authenticated|polling|active|listening|idle/);
        tLine(ok?'t-green':'t-yellow','  '+k+': '+v);
      });
    }else if(cmd==='status'){
      const r=await fetch(BE+'/api/status?key='+AK).then(r=>r.json());
      tLine('t-green','HTTP 200');
      tLine('t-green','  tvl: R$ '+parseFloat(r.protocol.tvl_brl).toFixed(2)+' ($'+parseFloat(r.protocol.tvl_usd).toFixed(2)+')');
      tLine('t-white','  supply: '+parseFloat(r.protocol.efix_total_supply).toFixed(2)+' efixDI');
      tLine('t-white','  brl/usd: '+r.protocol.brl_usd_rate);
      tLine('t-green','  vault: '+(r.protocol.vault_paused===false?'active':'PAUSED')+' | bridge: '+(r.protocol.bridge_paused===false?'active':'PAUSED'));
      tLine('t-white','  operator: '+parseFloat(r.operator.balances.matic).toFixed(2)+' MATIC');
      tLine('t-green','  hausbank: '+(r.services.hausbank.authenticated?'authenticated':'disconnected')+' (circuit: '+r.services.hausbank.circuit.state+')');
      tLine('t-green','  risky_positions: '+r.services.keeper.risky_positions);
    }else if(cmd==='morpho'){
      tLine('t-dim','Morpho Blue Position (Base Mainnet)');
      tLine('t-white','  market: efixDI/USDC | id: 0x31d65c...345a');
      tLine('t-green','  collateral: 25 efixDI (~$4.79)');
      tLine('t-white','  borrowed: 2.5 USDC');
      tLine('t-white','  ltv: 52.2% / 77% LLTV');
      tLine('t-green','  health_factor: 1.475');
      tLine('t-white','  borrow_rate: 0.67% APR');
      tLine('t-green','  net_yield: ~25.4% APY (at target LTV)');
      tLine('t-dim','  vault_v2: 0xf4A3...CBd5 (listing PR #936 pending)');
    }
  }catch(e){tLine('t-red','Network error: '+e.message+'. Try from your terminal.')}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARCHITECTURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const polyContracts=[
  ['EfixDIToken','0x0408...6441','ERC20 + mint/burn'],
  ['EfixVaultV2','0x2eA5...307C','Core vault logic'],
  ['PIXBridge','0x1d97...78f4','Fiat on/off-ramp'],
  ['OFT Adapter V2','0x6032...258Fc','LayerZero bridge'],
  ['Chainlink BRL/USD','0xB90D...AB7c','Price feed'],
  ['BRTHSwap','0xfBfC...8800','BRTH conversion'],
];
const baseContracts=[
  ['EfixDITokenBase','0xF5cA...5608','Bridged token'],
  ['MinterBurner','0x400a...B9a3','LZ mint/burn'],
  ['EfixBRLOracleV2','0xFC6a...Ea86','Price feed (4h)'],
  ['Morpho Vault V2','0xf4A3...CBd5','USDC lending'],
  ['Morpho Blue','0xBBBB...FFCb','efixDI/USDC market'],
];
const services=[
  ['‚úÖ Auto-Mint Poller','30s interval via HausBank'],
  ['‚úÖ Withdrawal Listener','Event-driven PIX cashout'],
  ['‚úÖ Keeper Bot','Health factor monitoring'],
  ['‚úÖ Circuit Breaker','Per-service failure isolation'],
  ['‚úÖ HausBank OAuth2','Auto-refresh (3600s TTL)'],
  ['‚úÖ Oracle Keeper','V2 update every 4 hours'],
];

function renderContracts(el,list){
  el.innerHTML=list.map(([n,a,d])=>`<div class="proto-item"><div><div class="proto-name">${n}</div><div class="proto-desc">${d}</div></div><div class="proto-addr">${a}</div></div>`).join('');
}
renderContracts(document.getElementById('archPoly'),polyContracts);
renderContracts(document.getElementById('archBase'),baseContracts);
document.getElementById('archSvc').innerHTML=services.map(([n,d])=>`<div class="svc-item"><div class="svc-name">${n}</div><div class="svc-desc">${d}</div></div>`).join('');
</script>
</body>
</html>
