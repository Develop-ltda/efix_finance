<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efix DeFi - Renda Fixa Tokenizada</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --black: #000000;
            --white: #ffffff;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Syne', -apple-system, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.7;
            min-height: 100vh;
        }
        
        ::selection {
            background: var(--black);
            color: var(--white);
        }
        
        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-200);
            z-index: 1000;
            padding: 1rem 2rem;
        }
        
        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            height: 32px;
            width: auto;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            transition: color 0.2s;
        }
        
        .nav-links a:hover {
            color: var(--black);
        }
        
        /* Connect Button */
        .connect-btn {
            background: var(--black);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .connect-btn:hover {
            background: var(--gray-800);
            transform: translateY(-1px);
        }
        
        .connect-btn.connected {
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--black);
        }
        
        /* Hero */
        .hero {
            padding: 10rem 2rem 4rem;
            text-align: center;
            background: var(--white);
            position: relative;
        }
        
        .hero-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800;
            color: var(--black);
            margin-bottom: 1rem;
            letter-spacing: -0.03em;
            line-height: 1.1;
        }
        
        .subtitle {
            color: var(--gray-500);
            font-size: 1.25rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto 2rem;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-100);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .status-badge .dot {
            width: 8px;
            height: 8px;
            background: var(--gray-400);
            border-radius: 50%;
        }
        
        .status-badge.connected .dot {
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        /* App Section */
        .app-section {
            padding: 4rem 0;
        }
        
        .app-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 900px) {
            .app-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Cards */
        .card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--black);
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .card-badge {
            background: var(--black);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Position Card */
        .position-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            background: var(--gray-100);
            padding: 1rem;
            border-radius: 12px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }
        
        .stat-value.highlight {
            color: var(--black);
        }
        
        /* Health Factor */
        .health-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .health-fill {
            height: 100%;
            background: var(--black);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .health-fill.safe { background: #22c55e; }
        .health-fill.warning { background: #f59e0b; }
        .health-fill.danger { background: #ef4444; }
        
        /* Action Buttons */
        .action-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            flex: 1;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            border: none;
        }
        
        .btn-primary {
            background: var(--black);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: var(--gray-800);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--black);
        }
        
        .btn-secondary:hover {
            background: var(--gray-100);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Input Group */
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .input-wrapper {
            display: flex;
            background: var(--gray-100);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        
        .input-wrapper:focus-within {
            border-color: var(--black);
        }
        
        .input-wrapper input {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            font-size: 1.1rem;
            font-family: 'Space Mono', monospace;
            outline: none;
        }
        
        .input-suffix {
            padding: 1rem;
            background: var(--gray-200);
            font-weight: 600;
            color: var(--gray-600);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: var(--gray-100);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 1.5rem;
        }
        
        .tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            font-family: inherit;
        }
        
        .tab.active {
            background: var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Leverage Slider */
        .leverage-control {
            margin: 1.5rem 0;
        }
        
        .leverage-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .leverage-value {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
        }
        
        .leverage-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: var(--gray-200);
            border-radius: 4px;
            outline: none;
        }
        
        .leverage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--black);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .leverage-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        /* QR Code */
        .qr-container {
            text-align: center;
            padding: 2rem;
            background: var(--gray-100);
            border-radius: 12px;
            margin-top: 1rem;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            background: var(--white);
            margin: 0 auto 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: var(--gray-500);
        }
        
        .qr-code img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-family: inherit;
        }
        
        .copy-btn:hover {
            background: var(--gray-100);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--black);
            color: var(--white);
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .toast.success {
            background: #22c55e;
        }
        
        /* Contract Links */
        .contracts-links {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .contract-link {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            background: var(--gray-100);
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
        }
        
        .contract-link:hover {
            background: var(--gray-200);
            color: var(--black);
        }
        
        /* Info Section */
        .info-section {
            padding: 4rem 0;
            border-top: 1px solid var(--gray-200);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }
        
        .info-card {
            text-align: center;
            padding: 2rem;
        }
        
        .info-icon {
            width: 48px;
            height: 48px;
            background: var(--black);
            color: var(--white);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.25rem;
        }
        
        .info-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .info-desc {
            color: var(--gray-600);
            font-size: 0.95rem;
        }
        
        /* Footer */
        footer {
            background: var(--black);
            color: var(--white);
            padding: 3rem 2rem;
            margin-top: 4rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .footer-logo {
            height: 24px;
            filter: invert(1);
        }
        
        .footer-text {
            color: var(--gray-500);
            font-size: 0.875rem;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--black);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            nav {
                padding: 1rem;
            }
            
            .nav-links {
                display: none;
            }
            
            .hero {
                padding: 8rem 1.5rem 3rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .position-stats {
                grid-template-columns: 1fr;
            }
            
            .action-group {
                flex-direction: column;
            }
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-content">
            <img src="logo_efix_400x400.jpg" alt="Efix" class="logo">
            <div class="nav-right">
                <ul class="nav-links">
                    <li><a href="#app">App</a></li>
                    <li><a href="#info">Como Funciona</a></li>
                    <li><a href="https://polygonscan.com/address/0x2eA512b4C5e53A8c1302AC8ba2d43c5DA90b307C" target="_blank">Contratos</a></li>
                </ul>
                <button id="connectBtn" class="connect-btn">Conectar Wallet</button>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <section class="hero">
        <img src="logo_efix_400x400.jpg" alt="Efix" class="hero-logo">
        <h1>Renda Fixa Tokenizada</h1>
        <p class="subtitle">Deposite BRL via PIX, receba tokens efixDI lastreados em CDI com rendimento de at√© 25% a.a.</p>
        <div id="statusBadge" class="status-badge">
            <span class="dot"></span>
            <span id="statusText">Desconectado</span>
        </div>
        <div class="contracts-links">
            <a href="https://polygonscan.com/address/0x04082b283818D9d0dd9Ee8742892eEe5CC396441" target="_blank" class="contract-link">Token</a>
            <a href="https://polygonscan.com/address/0x2eA512b4C5e53A8c1302AC8ba2d43c5DA90b307C" target="_blank" class="contract-link">Vault</a>
            <a href="https://polygonscan.com/address/0x13AB76468eFE0d35f2700DEcBd52Ce28f8827A0C" target="_blank" class="contract-link">Pool</a>
        </div>
    </section>

    <!-- App Section -->
    <section id="app" class="app-section">
        <div class="container">
            <div class="app-grid">
                <!-- Position Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Sua Posi√ß√£o</span>
                        <span class="card-badge" id="apyBadge">~22% APY</span>
                    </div>
                    
                    <div class="position-stats">
                        <div class="stat-item">
                            <div class="stat-label">Principal</div>
                            <div class="stat-value" id="principalValue">R$ 0,00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">efixDI</div>
                            <div class="stat-value highlight" id="efixdiValue">0,00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">D√≠vida USDC</div>
                            <div class="stat-value" id="debtValue">$0,00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Loops</div>
                            <div class="stat-value" id="loopsValue">0</div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                            <span>Health Factor</span>
                            <span id="healthValue" style="font-weight: 700;">‚àû</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill safe" id="healthFill" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <!-- Leverage Control -->
                    <div class="leverage-control">
                        <div class="leverage-header">
                            <span class="input-label">Alavancagem</span>
                            <span class="leverage-value" id="leverageDisplay">0x</span>
                        </div>
                        <input type="range" class="leverage-slider" id="leverageSlider" min="0" max="3" value="0" step="1">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                            <span>0x (15%)</span>
                            <span>1x (22%)</span>
                            <span>2x (27%)</span>
                            <span>3x (32%)</span>
                        </div>
                    </div>
                    
                    <div class="action-group">
                        <button class="btn btn-primary" id="leverageBtn" disabled>Aplicar Leverage</button>
                        <button class="btn btn-secondary" id="deleverageBtn" disabled>Remover</button>
                    </div>
                </div>
                
                <!-- Deposit/Withdraw Card -->
                <div class="card">
                    <div class="tabs">
                        <button class="tab active" data-tab="deposit">Depositar</button>
                        <button class="tab" data-tab="withdraw">Sacar</button>
                    </div>
                    
                    <!-- Deposit Tab -->
                    <div id="depositTab">
                        <div class="input-group">
                            <label class="input-label">Valor do Dep√≥sito</label>
                            <div class="input-wrapper">
                                <input type="number" id="depositAmount" placeholder="0,00" min="10" step="0.01">
                                <span class="input-suffix">BRL</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" id="generatePixBtn" style="width: 100%;">
                            Gerar QR Code PIX
                        </button>
                        
                        <div id="qrContainer" class="qr-container hidden">
                            <div class="qr-code" id="qrCode">
                                Gerando QR Code...
                            </div>
                            <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 1rem;">
                                Escaneie o QR Code ou copie o c√≥digo
                            </p>
                            <button class="copy-btn" id="copyPixBtn">
                                üìã Copiar c√≥digo PIX
                            </button>
                            <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 1rem;">
                                Ap√≥s o pagamento, seus tokens ser√£o mintados automaticamente.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Withdraw Tab -->
                    <div id="withdrawTab" class="hidden">
                        <div class="input-group">
                            <label class="input-label">Valor do Saque</label>
                            <div class="input-wrapper">
                                <input type="number" id="withdrawAmount" placeholder="0,00" min="1" step="0.01">
                                <span class="input-suffix">efixDI</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Chave PIX</label>
                            <div class="input-wrapper">
                                <input type="text" id="pixKey" placeholder="CPF, email, telefone ou chave aleat√≥ria">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" id="withdrawBtn" style="width: 100%;" disabled>
                            Sacar via PIX
                        </button>
                        
                        <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 1rem; text-align: center;">
                            ‚ö†Ô∏è Voc√™ deve remover toda alavancagem antes de sacar.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Info Section -->
    <section id="info" class="info-section">
        <div class="container">
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-icon">üí∞</div>
                    <div class="info-title">Dep√≥sito via PIX</div>
                    <div class="info-desc">Deposite reais instantaneamente via PIX. Seus tokens s√£o mintados automaticamente.</div>
                </div>
                <div class="info-card">
                    <div class="info-icon">üìà</div>
                    <div class="info-title">Rendimento CDI</div>
                    <div class="info-desc">Tokens lastreados em Fundo DI com liquidez D+0 e rendimento de ~15% a.a.</div>
                </div>
                <div class="info-card">
                    <div class="info-icon">‚ö°</div>
                    <div class="info-title">Alavancagem DeFi</div>
                    <div class="info-desc">Amplifique seus rendimentos com alavancagem segura usando USDC. At√© 32% APY.</div>
                </div>
                <div class="info-card">
                    <div class="info-icon">üîí</div>
                    <div class="info-title">100% On-Chain</div>
                    <div class="info-desc">Contratos auditados na Polygon. Seus tokens, sua cust√≥dia.</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <img src="logo_efix_400x400.jpg" alt="Efix" class="footer-logo">
            <p class="footer-text">¬© 2026 Efix Finance. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Contract Addresses (Polygon Mainnet)
        const CONTRACTS = {
            vault: '0x2eA512b4C5e53A8c1302AC8ba2d43c5DA90b307C',
            efixDIToken: '0x04082b283818D9d0dd9Ee8742892eEe5CC396441',
            pixBridge: '0x1d97f1adbf545F3C99d33A6a2166Ee423A78f4C3',
            lendingPool: '0x13AB76468eFE0d35f2700DEcBd52Ce28f8827A0C',
            oracle: '0xD9d24596DDAbB1CcE603D4d8AD04A97c1836Ae94'
        };

        const POLYGON_CHAIN_ID = '0x89'; // 137

        // ABIs
        const VAULT_ABI = [
            'function positions(address) view returns (uint256 principal, uint256 efixDIBalance, uint256 borrowedUSDC, uint256 leverageLoops, uint256 lastUpdateTimestamp, bool hedgeActive)',
            'function getHealthFactor(address) view returns (uint256)',
            'function applyLeverage(uint8 loops) external',
            'function deleverage(uint8 loops) external',
            'function withdraw(uint256 amount, string pixKey) external'
        ];

        const TOKEN_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function allowance(address owner, address spender) view returns (uint256)'
        ];

        // State
        let provider = null;
        let signer = null;
        let userAddress = null;
        let contracts = {};
        let currentPosition = null;
        let pixCode = null;

        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const statusBadge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');
        const toast = document.getElementById('toast');

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            // Setup event listeners
            connectBtn.addEventListener('click', connectWallet);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Leverage slider
            document.getElementById('leverageSlider').addEventListener('input', updateLeverageDisplay);
            
            // Buttons
            document.getElementById('generatePixBtn').addEventListener('click', generatePixQR);
            document.getElementById('copyPixBtn').addEventListener('click', copyPixCode);
            document.getElementById('leverageBtn').addEventListener('click', applyLeverage);
            document.getElementById('deleverageBtn').addEventListener('click', removeLeverage);
            document.getElementById('withdrawBtn').addEventListener('click', withdrawFunds);
            
            // Check if already connected
            if (window.ethereum) {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', handleAccountChange);
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        async function connectWallet() {
            if (!window.ethereum) {
                showToast('Por favor, instale a MetaMask!', 'error');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                // Request accounts
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                // Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== POLYGON_CHAIN_ID) {
                    await switchToPolygon();
                }
                
                // Setup provider
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = accounts[0];
                
                // Setup contracts
                contracts.vault = new ethers.Contract(CONTRACTS.vault, VAULT_ABI, signer);
                contracts.token = new ethers.Contract(CONTRACTS.efixDIToken, TOKEN_ABI, signer);
                
                // Update UI
                updateConnectedUI();
                await loadPosition();
                
                showToast('Wallet conectada!', 'success');
                
            } catch (error) {
                console.error('Connect error:', error);
                showToast('Erro ao conectar: ' + error.message, 'error');
            }
        }

        async function switchToPolygon() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: POLYGON_CHAIN_ID }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: POLYGON_CHAIN_ID,
                            chainName: 'Polygon Mainnet',
                            nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
                            rpcUrls: ['https://polygon-rpc.com'],
                            blockExplorerUrls: ['https://polygonscan.com']
                        }]
                    });
                }
            }
        }

        function handleAccountChange(accounts) {
            if (accounts.length === 0) {
                userAddress = null;
                updateDisconnectedUI();
            } else {
                userAddress = accounts[0];
                updateConnectedUI();
                loadPosition();
            }
        }

        function updateConnectedUI() {
            const shortAddr = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
            connectBtn.textContent = shortAddr;
            connectBtn.classList.add('connected');
            statusBadge.classList.add('connected');
            statusText.textContent = 'Polygon Mainnet';
            
            // Enable buttons
            document.getElementById('leverageBtn').disabled = false;
            document.getElementById('deleverageBtn').disabled = false;
            document.getElementById('withdrawBtn').disabled = false;
        }

        function updateDisconnectedUI() {
            connectBtn.textContent = 'Conectar Wallet';
            connectBtn.classList.remove('connected');
            statusBadge.classList.remove('connected');
            statusText.textContent = 'Desconectado';
            
            // Disable buttons
            document.getElementById('leverageBtn').disabled = true;
            document.getElementById('deleverageBtn').disabled = true;
            document.getElementById('withdrawBtn').disabled = true;
        }

        async function loadPosition() {
            if (!contracts.vault || !userAddress) return;
            
            try {
                const position = await contracts.vault.positions(userAddress);
                const hf = await contracts.vault.getHealthFactor(userAddress);
                
                currentPosition = {
                    principal: position[0],
                    efixDIBalance: position[1],
                    borrowedUSDC: position[2],
                    leverageLoops: Number(position[3])
                };
                
                // Update UI
                document.getElementById('principalValue').textContent = 
                    'R$ ' + parseFloat(ethers.formatEther(position[0])).toFixed(2).replace('.', ',');
                document.getElementById('efixdiValue').textContent = 
                    parseFloat(ethers.formatEther(position[1])).toFixed(2).replace('.', ',');
                document.getElementById('debtValue').textContent = 
                    '$' + parseFloat(ethers.formatUnits(position[2], 6)).toFixed(2);
                document.getElementById('loopsValue').textContent = position[3].toString();
                
                // Health Factor
                let hfValue = '‚àû';
                let hfPercent = 100;
                let hfClass = 'safe';
                
                if (hf.toString() !== ethers.MaxUint256.toString()) {
                    const hfNum = Number(hf) / 1e16;
                    hfValue = hfNum.toFixed(2);
                    hfPercent = Math.min(100, (hfNum / 3) * 100);
                    
                    if (hfNum < 1.1) hfClass = 'danger';
                    else if (hfNum < 1.3) hfClass = 'warning';
                }
                
                document.getElementById('healthValue').textContent = hfValue;
                const healthFill = document.getElementById('healthFill');
                healthFill.style.width = hfPercent + '%';
                healthFill.className = 'health-fill ' + hfClass;
                
                // Update APY badge
                const loops = Number(position[3]);
                const apys = [15, 22, 27, 32];
                document.getElementById('apyBadge').textContent = '~' + apys[Math.min(loops, 3)] + '% APY';
                
                // Update leverage slider
                document.getElementById('leverageSlider').value = loops;
                updateLeverageDisplay();
                
            } catch (error) {
                console.error('Load position error:', error);
            }
        }

        function updateLeverageDisplay() {
            const slider = document.getElementById('leverageSlider');
            const value = parseInt(slider.value);
            document.getElementById('leverageDisplay').textContent = value + 'x';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.getElementById('depositTab').classList.toggle('hidden', tab !== 'deposit');
            document.getElementById('withdrawTab').classList.toggle('hidden', tab !== 'withdraw');
        }

        // Backend URL - PIX Bridge Server
        const PIX_BACKEND_URL = 'https://prointegration-bastioned-yaretzi.ngrok-free.dev';

        async function generatePixQR() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            
            if (!amount || amount < 1) {
                showToast('Valor m√≠nimo: R$ 1,00', 'error');
                return;
            }

            if (!userAddress) {
                showToast('Conecte sua wallet primeiro', 'error');
                return;
            }
            
            showToast('Gerando QR Code...', 'success');
            
            const qrContainer = document.getElementById('qrContainer');
            const qrCode = document.getElementById('qrCode');
            
            qrContainer.classList.remove('hidden');
            qrCode.innerHTML = '<div class="loading"></div>';
            
            try {
                // Call backend to generate real PIX QR Code
                const response = await fetch(PIX_BACKEND_URL + '/api/pix/qrcode', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        amount: amount.toFixed(2),
                        walletAddress: userAddress
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao gerar QR Code');
                }
                
                // Store the EMV code for copy function
                pixCode = data.qrcode.emv;
                
                // Display QR Code
                qrCode.innerHTML = `
                    <img src="${data.qrcode.imageUrl}" alt="QR Code PIX" style="border-radius: 8px;">
                    <p style="margin-top: 12px; font-size: 0.875rem; color: var(--gray-500);">
                        Valor: <strong>R$ ${parseFloat(data.qrcode.amount).toFixed(2).replace('.', ',')}</strong>
                    </p>
                `;
                
                showToast('QR Code gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('PIX QR Error:', error);
                qrCode.innerHTML = '<p style="color: red;">Erro ao gerar QR Code</p>';
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function copyPixCode() {
            if (pixCode) {
                navigator.clipboard.writeText(pixCode);
                showToast('C√≥digo PIX copiado!', 'success');
            }
        }

        async function applyLeverage() {
            if (!contracts.vault || !userAddress) {
                showToast('Conecte sua wallet primeiro', 'error');
                return;
            }
            
            const targetLoops = parseInt(document.getElementById('leverageSlider').value);
            const currentLoops = currentPosition?.leverageLoops || 0;
            
            if (targetLoops <= currentLoops) {
                showToast('Selecione um n√≠vel maior de alavancagem', 'error');
                return;
            }
            
            const loopsToApply = targetLoops - currentLoops;
            
            try {
                // Check allowance
                const allowance = await contracts.token.allowance(userAddress, CONTRACTS.vault);
                if (allowance < ethers.MaxUint256 / 2n) {
                    showToast('Aprovando tokens...', 'success');
                    const approveTx = await contracts.token.approve(CONTRACTS.vault, ethers.MaxUint256);
                    await approveTx.wait();
                }
                
                showToast('Aplicando alavancagem...', 'success');
                const tx = await contracts.vault.applyLeverage(loopsToApply);
                await tx.wait();
                
                showToast('Alavancagem aplicada!', 'success');
                await loadPosition();
                
            } catch (error) {
                console.error('Leverage error:', error);
                showToast('Erro: ' + (error.reason || error.message), 'error');
            }
        }

        async function removeLeverage() {
            if (!contracts.vault || !userAddress) {
                showToast('Conecte sua wallet primeiro', 'error');
                return;
            }
            
            const currentLoops = currentPosition?.leverageLoops || 0;
            
            if (currentLoops === 0) {
                showToast('Voc√™ n√£o tem alavancagem ativa', 'error');
                return;
            }
            
            try {
                showToast('Removendo alavancagem...', 'success');
                const tx = await contracts.vault.deleverage(1);
                await tx.wait();
                
                showToast('Alavancagem removida!', 'success');
                await loadPosition();
                
            } catch (error) {
                console.error('Deleverage error:', error);
                showToast('Erro: ' + (error.reason || error.message), 'error');
            }
        }

        async function withdrawFunds() {
            if (!contracts.vault || !userAddress) {
                showToast('Conecte sua wallet primeiro', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const pixKey = document.getElementById('pixKey').value;
            
            if (!amount || amount <= 0) {
                showToast('Digite um valor v√°lido', 'error');
                return;
            }
            
            if (!pixKey) {
                showToast('Digite sua chave PIX', 'error');
                return;
            }
            
            if (currentPosition?.leverageLoops > 0) {
                showToast('Remova toda alavancagem antes de sacar', 'error');
                return;
            }
            
            try {
                showToast('Processando saque...', 'success');
                const amountWei = ethers.parseEther(amount.toString());
                const tx = await contracts.vault.withdraw(amountWei, pixKey);
                await tx.wait();
                
                showToast('Saque solicitado! PIX em at√© 30 min.', 'success');
                await loadPosition();
                
            } catch (error) {
                console.error('Withdraw error:', error);
                showToast('Erro: ' + (error.reason || error.message), 'error');
            }
        }

        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
